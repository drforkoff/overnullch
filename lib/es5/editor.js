'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&'function'==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?'symbol':typeof obj},_templateObject=_taggedTemplateLiteral(['#',''],['#','']),_templateObject2=_taggedTemplateLiteral(['#position-tweak-',''],['#position-tweak-','']),_templateObject3=_taggedTemplateLiteral(['#bgc-',''],['#bgc-','']),_templateObject4=_taggedTemplateLiteral(['<li class="cat-brd ','">\n\t\t<input type="text" class="board-dir" value="','">\n\t\t<input type="text" class="board-desc" value="','">\n\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t<button class="b-option delb delboard" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443"><svg class="icon"><use xlink:href="#i-x"></use></svg></button>\n\t</li>'],['<li class="cat-brd ','">\n\t\t<input type="text" class="board-dir" value="','">\n\t\t<input type="text" class="board-desc" value="','">\n\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t<button class="b-option delb delboard" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443"><svg class="icon"><use xlink:href="#i-x"></use></svg></button>\n\t</li>']),_templateObject5=_taggedTemplateLiteral(['#tree .invalid.inv_',''],['#tree .invalid.inv_','']),_templateObject6=_taggedTemplateLiteral(['#','-tipper'],['#','-tipper']),_templateObject7=_taggedTemplateLiteral(['','','',''],['','','','']),_templateObject8=_taggedTemplateLiteral(['#','Color'],['#','Color']),_templateObject9=_taggedTemplateLiteral(['<li class="stream','">\n\t\t<input type="text" class="stream-name" placeholder="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" title="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t\t<input type="text" class="stream-range" placeholder="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" title="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" maxlength="20" value="','">\n\t\t<div class="stream-options">\n\t\t\t<button class="b-option templatize" title="\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443"><svg class="icon">\n\t\t\t\t<use class="for-templated-hide" xlink:href="#i-template"></use>\n\t\t\t\t<use class="for-templated-show" xlink:href="#i-untemplate"></use>\n\t\t\t</svg></button>\n\t\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t\t<button class="b-option delstream" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C"><svg class="icon"><use xlink:href="#i-x"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type="text" class="stream-path" placeholder="/path \u0441\u0442\u0440\u0438\u043C\u0430" title="/path \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="50" value="','">\n\t\t<input type="text" class="stream-mime" placeholder="MIME \u0441\u0442\u0440\u0438\u043C\u0430" title="MIME \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t</li>'],['<li class="stream','">\n\t\t<input type="text" class="stream-name" placeholder="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" title="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t\t<input type="text" class="stream-range" placeholder="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" title="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" maxlength="20" value="','">\n\t\t<div class="stream-options">\n\t\t\t<button class="b-option templatize" title="\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443"><svg class="icon">\n\t\t\t\t<use class="for-templated-hide" xlink:href="#i-template"></use>\n\t\t\t\t<use class="for-templated-show" xlink:href="#i-untemplate"></use>\n\t\t\t</svg></button>\n\t\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t\t<button class="b-option delstream" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C"><svg class="icon"><use xlink:href="#i-x"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type="text" class="stream-path" placeholder="/path \u0441\u0442\u0440\u0438\u043C\u0430" title="/path \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="50" value="','">\n\t\t<input type="text" class="stream-mime" placeholder="MIME \u0441\u0442\u0440\u0438\u043C\u0430" title="MIME \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t</li>']),_templateObject10=_taggedTemplateLiteral(['#streams .invalid.inv_',''],['#streams .invalid.inv_','']),_templateObject11=_taggedTemplateLiteral(['.stream-',''],['.stream-','']),_templateObject12=_taggedTemplateLiteral(['<li class="lib-chan sect-','','" id="chan_','" data-search="','">\n\t\t\t<img src="','" class="lib-chanball">\n\t\t\t<div class="chan-title">','</div>'],['<li class="lib-chan sect-','','" id="chan_','" data-search="','">\n\t\t\t<img src="','" class="lib-chanball">\n\t\t\t<div class="chan-title">','</div>']),_templateObject13=_taggedTemplateLiteral(['#chan_',''],['#chan_','']),_templateObject14=_taggedTemplateLiteral(['.tab[data-tab=',']'],['.tab[data-tab=',']']),_templateObject15=_taggedTemplateLiteral(['#chan-',''],['#chan-','']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}))}var IS_ADMIN=!1,main=function(){function saveAsNewDraft(){return libchan.setMode('new','drafts'),drafts.submit(1),!1}LSfetchJSON('IS_ADMIN')&&(IS_ADMIN=!0,$('body').addClass('is-admin')),$('#chan-library').toggleClass('expanded',1==localStorage['chanlib-expanded']),setTimeout(function(){return injector.inject('lib-collapse','.collapsible-content {  transition: width 0.3s; }')},100),$.ajaxSetup({dataType:'json'}),$('.tipper').each(function(){$(this).prepend('\n\t\t\t<svg class="icon t-i-q"><use xlink:href="#i-question"></use></svg>\n\t\t\t<svg class="icon t-i-e"><use xlink:href="#i-warning"></use></svg>\n\t\t\t<svg class="icon t-i-s spinning"><use xlink:href="#i-spinner"></use></svg>\n\t\t\t<svg class="icon t-i-ok"><use xlink:href="#i-check"></use></svg>')}).append('<div class="tooltip-wrap error-msg"><div class="tooltip"></div></div>'),$('.validable').each(function(){var _this2=this,$tipper=$(this).parents('.tip-container').find('.tipper');this.showErrors=mkErrorShower($tipper),this.errorDescriptors={"too-long":'\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0434\u043B\u0438\u043D\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F',"too-short":'\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F',invalid:'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0430\u043D\u043D\u044B\u0445',missing:'\u041F\u043E\u043B\u0435 \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E \u0434\u043B\u044F \u0432\u0432\u043E\u0434\u0430',occupied:'\u0417\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0437\u0430\u043D\u044F\u0442\u043E'},$(this).attr('pattern')&&(this.patternRX=new RegExp($(this).attr('pattern'))),this.validate=function(silent,isDraft){return new Promise(function(resolve,reject){var $this=$(_this2),val=$this.val(),errors=[];if(val=val.trim(),$this.val(val),val){var maxlength=$this.attr('maxlength'),minlength=$this.attr('minlength');minlength&&val.length<minlength&&errors.push('\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F (\u043D\u0443\u0436\u043D\u043E \u043C\u0438\u043D\u0438\u043C\u0443\u043C '+minlength+' \u0441\u0438\u043C\u0432.)'),_this2.patternRX&&!val.match(_this2.patternRX)&&errors.push('invalid');var vconv=$this.data('valconvert');vconv&&validations.hasOwnProperty(vconv)&&(val=validations[vconv](val)),maxlength&&val.length>maxlength&&errors.push('\u041F\u0440\u0435\u0432\u044B\u0448\u0435\u043D\u0430 \u043C\u0430\u043A\u0441. \u0434\u043B\u0438\u043D\u0430 \u043F\u043E\u043B\u044F ('+maxlength+' \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432)')}else $(_this2).prop('required')&&errors.push('missing');var finalize=function(){silent||_this2.showErrors(errors),errors.length?isDraft?resolve(val):reject(errors):($tipper.setTipperState('valid'),resolve(val))},afterValid=$this.data('aftervalid');errors.length?finalize():($tipper.setTipperState('spinner'),afterValid&&validations[afterValid]?validations[afterValid](val,$this.data('uniq')).then(function(){return finalize()},function(err){errors.push(err),finalize()}):finalize())})}}).on('focus',function(){var $this=$(this),$sect=$this.parents('.tip-container'),$tipper=$sect.find('.tipper')}),$('.validable:not(.no-val-onblur)').on('blur',function(){this.validate().then(_.noop,_.noop)}),$('#color-selector .colorbox').change(gradient.update.bind(gradient)),$('#change-direction').click(function(){var $use=$(this).find('use'),minus=0>$use.attr('transform').indexOf('-90');$use.attr('transform','rotate('+(minus?'-':'')+'90 8 8)');var _from=$('#bgc-from')[0],_to=$('#bgc-to')[0],_ref=[_to.id,_from.id];_from.id=_ref[0],_to.id=_ref[1],gradient.update()}),$('body').on('click','.add-board',function(){tree.addBoard($(this))}).on('click','.delboard',function(){tree.removeBoard($(this))}).on('click','.delcat',function(){var $cat=$(this).parents('.tree-cat');$cat.hasClass('predelete')||$cat.hasClass('empty')?tree.removeCategory($(this)):$cat.addClass('predelete')}).on('click','.cat-undelete',function(){$(this).parents('.tree-cat').removeClass('predelete')}).on('click','.f-minus, .f-plus',function(){$(this).parents('.tree-cat').toggleClass('hidden')}).on('click','.add-cat',tree.addCategory.bind(tree)).on('input','.board-dir',function(){$(this).parents('.cat-brd').toggleClass('external',!!$(this).val().match(/^https?:\/\//))}).on('mouseup mouseleave blur touchend touchcancel',function(){isMouseDown=!1}).on('click','.delstream',function(){radio.removeStream($(this))}).on('click','.templatize',function(){$(this).parents('.stream').toggleClass('templated').find('.stream-range').focus()}).on('blur','#tree input',tree.validateUI.bind(tree)).on('click','.lib-chan',function(){libchan.load(this._libdata)}).on('dragenter dragend dragover drop dragleave',function(ev){ev.preventDefault(),ev.stopPropagation()}).on('dragenter',function(){$(this).addClass('dropping'),clearTimeout(this.offTimeout)}).on('dragend drop dragleave',function(ev){var _this3=this;ev.currentTarget===ev.target&&(this.offTimeout=setTimeout(function(){$(_this3).removeClass('dropping')},100))}).on('click','.export-draft',function(ev){ev.stopPropagation();var $ch=$(this).parent('.lib-chan'),data=$ch[0]._libdata;downloadJSON(data,data.id)}),$('.chanball-wrap').on('dragenter dragend dragover drop dragleave',function(ev){ev.preventDefault(),ev.stopPropagation()}).on('dragenter dragover',function(){$(this).addClass('file-over'),clearTimeout(this.offTimeout)}).on('dragend drop dragleave',function(){var _this4=this;this.offTimeout=setTimeout(function(){$(_this4).removeClass('file-over')},100)}).on('drop',ball.handleFile.bind(ball)),$('#radio-editor').on('blur','input',function(){radio.getData().then(_.noop,_.noop)});var isMouseDown=!1;$('.chanball-dropzone').click(function(){return $('#chanballFileInput').click()}),$('#chanballFileInput').on('change',ball.handleFile.bind(ball)),$('#view-toggle .switch-body').click(function(){return tree.toggleView()}),$('#view-toggle label').click(function(){tree.toggleView($(this).text())}),$('#reup-chanball').click(function(){$('#chanballFileInput').click()}),$('.password-reveal').on('mousedown',function(){$(this).parent().find('input').attr('type','text')}).on('mouseleave mouseup',function(){$(this).parent().find('input').attr('type','password')}),$('#pswd').on('focus',function(){this.removeAttribute('readonly')}).on('blur',function(){this.setAttribute('readonly',!0)}),$('.cb-position-tweaker button').on('mousedown touchstart',function(){var _this5=this;isMouseDown=!0;var inc=function(override){if(!override&&!isMouseDown)return clearInterval(_this5.incrementor);var $input=$(_this5).parent().find('input'),inc=+$(_this5).data('inc');$input.val(+$input.val()+inc),ball.offset()};inc(!0),this.incrementor=setInterval(inc,150)}).parent().find('input').on('input paste change',ball.offset),$('#tree-json').on('blur',function(){tree.validateJSON()}),$('#chan-name').on('input paste change',function(){$('.channame-overlay').text($(this).val())}),$('#color-theme input.color').change(styles.update.bind(styles)),$('#less-enter').on('input',styles.update.bind(styles)),$('#less-preamble').html(styles.preamble('html')),$('#less-enter').val(styles.base),$('.binded').each(function(){var $this=$(this),bindID=$this.data('bind'),$b=$(jq(_templateObject,bindID));$b.length&&$b.on('input change paste',function(){$this.text($(this).val()||'{'+bindID+'}')}).trigger('change')}),window.updateBindings=function(){$('.binded').each(function(){$(jq(_templateObject,$(this).data('bind'))).trigger('change')})},$('#advance-less').change(function(){var $area=$('#less-enter');$(this).prop('checked')?$('.advanced-less').slideDown(function(){$area.prop('disabled',0),$area[0].preValue&&$area.val($area[0].preValue)}):($area[0].preValue=$area.val(),$area.val(styles.base).prop('disabled',1)),styles.update()}),$('.captcha').click(refreshCaptcha).addClass('not-loaded'),$('.widget-list input').on('change',function(){$(jq(_templateObject,$(this).attr('name'))).toggle($(this).prop('checked'))}),$('.expander').click(function(){$(this).parents('.expandee').toggleClass('expanded')}),$('#onchan').on('change',function(){$('.chan').toggleClass('onchan',$(this).prop('checked'))}),styles.update(),$('#add-stream').click(radio.addStream.bind(radio)),Sortable.create(document.querySelector('#categories'),{handle:'.cat-dragger',animation:150}),Sortable.create(document.querySelector('#streams'),{handle:'.dragger',animation:150}),$('.sidebar').click(toggleLib);var lastTab='default';$('.tab').click(function(){var tabID=$(this).data('tab'),$lib=$('#chan-library'),f=!1;'search'===tabID?$lib.hasClass('show-search')?tabID=lastTab:f=!0:lastTab=tabID,$lib.find('.tab').removeClass('selected'),$lib.find('.tab[data-tab='+tabID+']').addClass('selected'),$lib.removeClass('show-custom show-default show-drafts show-search').addClass('show-'+tabID),f&&$('#searchbox').focus()}),$('#searchbox').on('input paste',function(){var val=$(this).val().trim().replace(/\"/g,'\\"').toLowerCase();val.length?injector.inject('lib-search','.show-search .lib-chan[data-search *= "'+val+'"] {height: 40px}'):injector.remove('lib-search')}),upForm.init(),$.getJSON('/chans/chans.json?v='+new Date().getTime()).done(function(data){return library.build(data.chans)}),$('#new-chan').click(function(){return libchan.clear()}),$('#clone-this').click(function(){return libchan.clone()}),$('#publish').click(function(){return upForm.toggle('upload')}),$('#delete-this').click(function(){return upForm.toggle('delete')}),$('#save-draft').click(function(){return drafts.submit()}),$('#draft-saveasnew').click(saveAsNewDraft),$('#draft-changeid').click(function(){drafts.remove(libchan.current.id),saveAsNewDraft()}),$('#draft-savemodifiedid').click(function(){return $('#chan-id').val($('#proposed-id').text()),drafts.submit(),!1}),$('#draft-overwrite').click(function(){return drafts.remove($('#id-to-overwrite').text()),drafts.submit(),!1}),drafts.load()};function refreshCaptcha(){$('.captcha').attr('src','/captcha.php?color=255,255,255&v='+Math.random()).removeClass('not-loaded'),$('#captcha').val('')}function toggleLib(on){$('#chan-library').toggleClass('expanded',on),localStorage['chanlib-expanded']=+$('#chan-library').hasClass('expanded')}var gradient={make:function make(direction,stop1,stop2){return'radial'===direction?'radial-gradient(ellipse at center, '+stop1+' 0%, '+stop2+' 100%)':'linear-gradient(to '+direction+', '+stop1+' 0%, '+stop2+' 100%)'},prefixify:function prefixify(input){var res=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(input);if(null===res)return'background:'+input;res=_.rest(_.without(res,void 0));var gradientDirection,ret=res[0]+'; ',gradientType=res[1];gradientDirection=isNaN(res[2])?'bottom'==res[2]?'top, ':'right'==res[2]?'left, ':'center, ellipse cover, ':90-parseFloat(res[2])+'deg, ';var gradientStops=res[3];return _.each(['-o-','-webkit-','-moz-'],function(prefix){ret+='background:'+prefix+gradientType+'('+gradientDirection+gradientStops+'); '}),'background:'+ret},getValue:function getValue(){var stop1='#'+$('#bgc-from').val(),stop2='#'+$('#bgc-to').val();return this.make('bottom',stop1,stop2)},update:function update(){var grad=this.getValue();injector.inject('chanball-background','.chanball-wrap { '+this.prefixify(grad)+' }')}},injector={inject:function inject(alias,css){var id='injector:'+alias,existing=document.getElementById(id);if(existing)return void(existing.innerHTML=css);var head=document.head||document.getElementsByTagName('head')[0],style=document.createElement('style');style.type='text/css',style.id=id,style.styleSheet?style.styleSheet.cssText=css:style.appendChild(document.createTextNode(css)),head.appendChild(style)},remove:function remove(alias){var id='injector:'+alias,style=document.getElementById(id);if(style){var head=document.head||document.getElementsByTagName('head')[0];head&&head.removeChild(document.getElementById(id))}}},ball={handleFile:function handleFile(ev){ev.stopPropagation(),ev.preventDefault(),ev=ev.originalEvent,$('body').removeClass('dropping');var files='drop'==ev.type?ev.dataTransfer.files:ev.target.files,f=files[0];if(f&&'image/png'==f.type){var reader=new FileReader;reader.onload=function(){return function(e){this.setBall(e.target.result)}.bind(this)}.bind(this)(f),reader.readAsDataURL(f)}else f&&this.showErrors('image-not-png')},setBall:function setBall(chan){var _this6=this,src=void 0;if('string'==typeof chan)src=chan;else if(!!chan.ball)src=chan.ball;else if('drafts'!==chan.section)src='/chans/balls/'+chan.section+'/'+chan.id+'.png?uid='+chan._id+(chan.ballv?'&v='+chan.ballv:'');else return void this.clear();var $ball=$('#chanball').attr('src',src);$ball.one('load',function(){200<$ball.width()||200<$ball.height?_this6.showErrors('image-too-large'):(_this6.file=src,_this6.fType=0===src.indexOf('data:')?'dataURL':'file',_this6.showErrors([]),$('#chanball-sect').addClass('chanball-present'))}),gradient.update()},clear:function clear(){$('#chanball-sect').removeClass('chanball-present'),this.file=null},getData:function getData(isDraft){var _this7=this;return new Promise(function(resolve,reject){var errors=[];_this7.file||errors.push('no-file');var offset=['left','top'].map(function(pos){var $input=$(jq(_templateObject2,pos)),val=+$input.val();return isNaN(val)&&(val=0),100<Math.abs(val)&&(val=100*Math.sign(val)),$input.val(val),val}),catbg=['from','to'].map(function(stop){var $input=$(jq(_templateObject3,stop)),val=$input.val();return val.match(/[0-9a-f]{6}/i)||(val='ffffff',$input[0].jscolor.fromString(val)),val});_this7.offset(),gradient.update(),_this7.showErrors(errors),errors.length&&!isDraft?reject(errors):resolve({ball:'file'===_this7.fType?'default':_this7.file,offset:offset,catbg:catbg})})},toDataURL:function toDataURL(){var _this8=this;'data'!=this.fType&&this.file&&getDataUri(this.file,function(data){_this8.file=data,_this8.fType='data'})},errorDescriptors:{"no-file":'\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442',"image-not-png":'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0442\u0438\u043F \u0444\u0430\u0439\u043B\u0430 (\u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C PNG)',"image-too-large":'\u0420\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430 \u043D\u0435 \u0434\u043E\u043B\u0436\u0435\u043D \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 200 \u043F\u043A\u0441',"upload-error":'\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u0438\u0438 \u0444\u0430\u0439\u043B\u0430'},file:null,fType:null,offset:function offset(){var top=+$('#position-tweak-top').val(),left=+$('#position-tweak-left').val();return $('#chanball').css({transform:'translate('+left+'px, '+top+'px)',"-webkit-transform":'translate('+left+'px, '+top+'px)',"-ms-transform":'translate('+left+'px, '+top+'px)',"-moz-transform":'translate('+left+'px, '+top+'px)',"-o-transform":'translate('+left+'px, '+top+'px)'}),[top,left]},showErrors:mkErrorShower('ball')},tree={build:function build(cats){var _this9=this,htm='';if(cats){if('string'==typeof cats)try{cats=JSON.parse(cats)}catch(e){return this.toggleView('JSON',!0),void $('#tree-json').val(cats)}cats.length&&this.isFlat(cats)&&(cats=[{name:'',boards:cats}]),cats.forEach(function(cat){htm+=_this9.buildCat(cat)})}return $('#categories').html(htm),document.querySelectorAll('.tree-cat ul').forEach(this.makeBoardsSortable.bind(this)),$('#tree-json').val(JSON.stringify(this.deconstruct(),null,'\t')),this.validateUI()},isFlat:function isFlat(cats){return cats[0].hasOwnProperty('dir')},boardHeight:24,addBoardButtonHeight:27,buildCat:function buildCat(cat){cat.boards=cat.boards||[];var boards=this.buildBoards(cat.boards),empty=0===cat.boards.length,maxHeight=(cat.boards.length+1)*this.boardHeight+this.addBoardButtonHeight;return'<div class="tree-cat '+(empty?'empty':'')+'">\n\t\t<div class="tree-cathead">\n\t\t\t<svg class="icon f-plus" title="\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C"><use xlink:href="#i-folder-plus-fill"></use></svg>\n\t\t\t<svg class="icon f-minus" title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"><use xlink:href="#i-folder-minus-fill"></use></svg>\n\t\t\t<svg class="icon f-empty"><use xlink:href="#i-folder-empty"></use></svg>\n\t\t\t<input type="text" class="cat-title" value="'+(_.escape(cat.name)||'')+'"></input>\n\t\t\t<button class="b-option cat-undelete" title="\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0435">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-undo"></use></svg>\n\t\t\t</button>\n\t\t\t<div class="cat-dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438">\n\t\t\t\t<svg class="b-option icon"><use xlink:href="#i-drag"></use></svg>\n\t\t\t</div>\n\t\t\t<button class="b-option delb delcat" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-x"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="tree-catboards" style="max-height: '+maxHeight+'px">'+boards+'</div></div>'},buildBoards:function buildBoards(boards){var _this10=this,htm='<ul>';return boards.forEach(function(brd){htm+=_this10.buildBoard(brd)}),htm+='</ul><button class="tree-add add-board" title="\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443">\n\t\t\t<div class="inner-border">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-slash-plus-slash"></use></svg>\n\t\t\t</div>\n\t\t</button>',htm},buildBoard:function buildBoard(brd){return escHTML(_templateObject4,brd.external?'external':'',brd.dir||brd.url||'',brd.desc||'')},recalcHeight:function recalcHeight($brds){$brds instanceof jQuery||($brds=$($brds).parent());var n=$brds.find('.cat-brd').length,px=(n+1)*this.boardHeight+this.addBoardButtonHeight;$brds.css({"max-height":px+'px'}),$brds.parent().toggleClass('empty',0==n)},addBoard:function addBoard($btn,board){board=board||{},$btn.parent().find('ul').append(this.buildBoard),this.recalcHeight($btn.parent()),$btn.parent().find('.cat-brd:last input:first').focus()},removeBoard:function removeBoard($btn){var $parent=$btn.parents('.tree-catboards');$btn.parents('.cat-brd').remove(),this.recalcHeight($parent),this.validateUI()},addCategory:function addCategory(cat){cat.hasOwnProperty('boards')||(cat={name:'',boards:[]});var $cat=$(this.buildCat(cat));this.makeBoardsSortable($cat.find('ul')[0]),$('#categories').append($cat),$cat.find('.cat-title').focus()},removeCategory:function removeCategory($btn){$btn.parents('.tree-cat').remove(),this.validateUI()},makeBoardsSortable:function makeBoardsSortable(el){var _this11=this;Sortable.create(el,{handle:'.dragger',animation:150,group:'boards',onAdd:function onAdd(ev){[ev.from,ev.to].forEach(_this11.recalcHeight.bind(_this11)),_this11.validateUI()}})},validateJSON:function validateJSON(){try{var cats=JSON.parse($('#tree-json').val());return this.build(cats),1}catch(e){return this.showErrors(e),$('#view-toggle').shake(),0}},validateUI:function validateUI(isDraft){var errors=[],obj=this.deconstruct();$('#tree .invalid').length&&_.keys(this.errorDescriptors).forEach(function(r){$(jq(_templateObject5,r)).length&&errors.push(r)});var allDirs=[],walkCat=function(brd){return allDirs.push(brd.external?brd.url:brd.dir)},catNames=[];obj.forEach(function(cat){catNames.push(cat.name),cat.boards.forEach(walkCat)});var dupCats=findDuplicates(catNames);if(dupCats.length){errors.push('mul-cat');var $cats=$('.cat-title');dupCats.forEach(function(i){return $($cats[i]).addClass('invalid')})}var dupDirs=findDuplicates(allDirs);if(dupDirs.length){errors.push('mul-dir');var $dirs=$('.board-dir');dupDirs.forEach(function(i){return $($dirs[i]).addClass('invalid')})}return this.showErrors(errors),(!errors.length||isDraft)&&obj},deconstruct:function deconstruct(){$('#tree .invalid').removeClass('invalid '+_.map(_.keys(this.errorDescriptors),function(k){return'inv_'+k}).join(' '));var cats=[],$cats=$('.tree-cat'),flat=!1;return 1==$cats.length&&(flat=!0),$('.tree-cat').each(function(){var $cat=$(this),boards=[],$boards=$cat.find('.cat-brd');$boards.length?$boards.each(function(){var $desc=$(this).find('.board-desc'),desc=$desc.val().trim();desc||$desc.addClass('invalid inv_no-desc');var board={desc:desc},$dir=$(this).find('.board-dir'),dir=$dir.val().trim();dir||$dir.addClass('invalid inv_no-dir');var external=!!dir.match(/^https?:\/\//);$(this).toggleClass('external',external),board[external?'url':'dir']=dir,external&&(board.external=!0),boards.push(board)}):$cat.addClass('invalid inv_empty-dir');var $name=$cat.find('.cat-title'),name=$name.val().trim();flat||name||$name.addClass('invalid inv_no-name'),cats.push({name:name,boards:boards})}),cats},toggleView:function toggleView(to,isDraft){var current=$('#chan-structure').hasClass('sw_UI')?'UI':'JSON';if('undefined'==typeof to&&(to='UI'==current?'JSON':'UI'),current==to)return null;if('JSON'===to)$('#tree-json').val(JSON.stringify(this.deconstruct(),null,'\t'));else{var JSON_valid=this.validateJSON();if(isDraft)return $('#tree-json').val();if(!JSON_valid)return!1}return $('#chan-structure').removeClass('sw_UI sw_JSON').addClass('sw_'+to),1},errorDescriptors:{"no-name":'\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0440\u0430\u0437\u0434\u0435\u043B\u0430',"no-dir":'\u041F\u0443\u0441\u0442\u043E\u0439 \u043F\u0443\u0442\u044C \u0434\u043E\u0441\u043A\u0438',"no-desc":'\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0434\u043E\u0441\u043A\u0438',"mul-dir":'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0434\u043E\u0441\u043E\u043A',"mul-cat":'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0440\u0430\u0437\u0434\u0435\u043B\u043E\u0432',"empty-dir":'\u041F\u0443\u0441\u0442\u043E\u0439 \u0440\u0430\u0437\u0434\u0435\u043B',"bad-json":'JSON \u2014 \u0438\u043D\u0432\u0430\u043B\u0438\u0434'},showErrors:mkErrorShower('struct')};function mkErrorShower(id){return function(errs){var _this12=this;errs instanceof Array||(errs=[errs]);var $tipper=id instanceof jQuery?id:$(jq(_templateObject6,id)),$msgbox=$tipper.find('.error-msg .tooltip'),any=0<errs.length,mul=1<errs.length,htm=(mul?'\u041E\u0431\u043D\u0430\u0440\u0443\u0436\u0435\u043D\u044B \u043E\u0448\u0438\u0431\u043A\u0438: <ul>':'')+errs.reduce(function(htm,er){return htm+escHTML(_templateObject7,mul?'<li>':'',_this12.errorDescriptors&&_this12.errorDescriptors[er]||er,mul?'</li>':'')},'')+(mul?'</ul>':'');$msgbox.html(htm),$tipper.setTipperState(any?'error-tip':'question'),any&&$tipper.shake(),this instanceof HTMLElement&&$(this).toggleClass('invalid',any)}}$.fn.shake=function(){var _this13=this;this.addClass('shake'),setTimeout(function(){return _this13.removeClass('shake')},900)},$.fn.setTipperState=function(state){this.removeClass(_.without(['question','error-tip','spinner','valid'],state).join(' ')).addClass(state)};function findDuplicates(arr){var dubs=[];return arr.forEach(function(el,i){1<arr.length-_.without(arr,el).length&&dubs.push(i)}),dubs}var styles={preamble:function(role){var vars=[];return['chan-id','bgColor','linkColor'].forEach(function(v){return vars[v]='html'==role?'<span class="binded" data-bind="'+v+'"></span>':$(jq(_templateObject,v)).val()}),'less'==role&&(vars['chan-id']='css-preview'),'.chan-'+vars['chan-id']+' {'+('\n  @bgcolor: #'+vars.bgColor+';')+('\n  @linkcolor: #'+vars.linkColor+';')},update:function(callback){var _this14=this;callback='function'==typeof callback?callback:null;var userCode=this.parseInput();if(!userCode)return void(callback&&callback(!1));var lessCode=this.preamble('less')+userCode+'}';less.render(lessCode).then(function(r){injector.inject('chanclass-preview',r.css),callback&&callback(!0)},function(err){_this14.showErrors(err.message),callback&&callback(!1)})},getData:function(isDraft){var _this15=this;return new Promise(function(resolve,reject){var res={colors:['bg','link'].map(function(c){var $input=$(jq(_templateObject8,c)),val=$input.val();return val.match(/[0-9a-f]{6}/i)||(val=$input.attr('value'),$input[0].jscolor.fromString(val)),val})};$('#advance-less').prop('checked')?(res.advanced_less=lessFormatter.minify($('#less-enter').val()),_this15.update(function(succ){isDraft||succ?resolve(res):reject()})):resolve(res)})},errorDescriptors:{"bracket-imbalance":'\u0421\u043A\u043E\u0431\u043A\u0438 \u043D\u0435 \u0441\u0431\u0430\u043B\u0430\u043D\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u044B'},parseInput:function(){var errors_found=[],val=$('#less-enter').val(),brackets=val.replace(/\/\*.+?\*\/|".+?"|'.+?'/,'').replace(/[^()\[\]{}]/g,''),isBalanced=function(str){for(var bracket={"]":'[',"}":'{',")":'('},openBrackets=[],isClean=!0,i=0,len=str.length;isClean&&i<len;i++)bracket[str[i]]?isClean=openBrackets.pop()===bracket[str[i]]:openBrackets.push(str[i]);return isClean&&!openBrackets.length}(brackets);return isBalanced||errors_found.push('bracket-imbalance'),this.showErrors(errors_found),!errors_found.length&&val},showErrors:mkErrorShower('style'),reset:function(){['bg','link'].forEach(function(field){var $input=$(jq(_templateObject8,field));$input[0].jscolor.fromString($input.data('default'))}),$('#advance-less').prop('checked',0).trigger('change'),this.update(),$('#custom-css').prop('checked',0).trigger('change')},base:'background: @bgcolor;\na, .chan-overlay .icon {\n\tcolor: @linkcolor;\n}\n&:hover {\n\tbackground: darken(@bgcolor, 8%);\n}\n&.onchan {\n\tbox-shadow: inset -2px 0 fadeout(@linkcolor, 25%);\n}\n& when (lightness(@bgcolor) < 70%) {\n\tcolor: #C3C3C3;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: white;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(255, 255, 255, .08);\n\t}\n}\n& when (lightness(@bgcolor) > 70%) {\n\tcolor: #404040;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: black;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(0, 0, 0, .08);\n\t}\n}\n'},radio={buildStream:function buildStream(strm){return escHTML(_templateObject9,strm.n?' templated':'',strm.name||'',strm.n||'',strm.path||'',strm.mime||'')},addStream:function addStream(strm){strm=strm||{};var $strm=$(this.buildStream(strm));$('#streams').append($strm)},build:function build(r){var _this16=this;$('#chan-radiourl').val(r.url),$('#streams').html(r.streams.reduce(function(htm,strm){return htm+_this16.buildStream(strm)},''))},removeStream:function removeStream($btn){return $btn.parents('.stream').remove()},reset:function reset(){this.build({url:'',streams:[]}),$('#radio-editor').hide(),$('#radio').prop('checked',!1)},getData:function getData(isDraft){var _this17=this;return new Promise(function(resolve,reject){var proceed=function(url,errors){errors=errors?errors.map(function(v){return'URL: '+v}):[],$('#chan-radiourl').toggleClass('invalid',!!errors.length),$('#streams input').removeClass('invalid '+_.map(_.keys(_this17.errorDescriptors),function(k){return'inv_'+k}).join(' '));var streams=[],$streams=$('.stream');$streams.length?($streams.each(function(){var $strm=$(this),stream={};if(['name','path','mime'].forEach(function(prop){var $input=$strm.find('.stream-'+prop),val=$input.val();val||$input.addClass('invalid inv_no-'+prop),stream[prop]=val}),streams.push(stream),$strm.hasClass('templated')){var $range=$strm.find('.stream-range'),n=$range.val();n?mixedRange(n).length?stream.n=n:$range.addClass('invalid inv_bad-range'):$range.addClass('invalid inv_no-range')}}),$('#streams .invalid').length&&_.keys(_this17.errorDescriptors).forEach(function(r){$(jq(_templateObject10,r)).length&&errors.push(r)}),['name','path'].forEach(function(prop){var dupProps=findDuplicates(_.pluck(streams,prop));if(dupProps.length){errors.push('mul-'+prop);var $inputs=$(jq(_templateObject11,prop));dupProps.forEach(function(i){return $($inputs[i]).addClass('invalid')})}})):errors.push('no-streams'),_this17.showErrors(errors),!isDraft&&errors.length?reject(errors):resolve({url:url,streams:streams})};$('#chan-radiourl')[0].validate(!0).then(function(val){proceed(val,null)},function(errors){proceed(null,errors)})})},showErrors:mkErrorShower('radio'),errorDescriptors:{"no-streams":'\u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0441\u0442\u0440\u0438\u043C',"no-name":'\u041F\u0443\u0441\u0442\u043E\u0435 \u0438\u043C\u044F \u0441\u0442\u0440\u0438\u043C\u0430',"no-path":'\u041F\u0443\u0441\u0442\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C',"no-mime":'\u041E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 MIME',"mul-name":'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u043E\u0432',"mul-path":'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0441\u0441\u044B\u043B\u043A\u0438 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u044B',"no-range":'\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F',"bad-range":'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D\u0430 \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F'}},library={build:function build(chans,section){var _this18=this;chans.forEach(function(chan){return _this18.addChan(chan,section||(chan.default?'default':'custom'))})},buildChan:function buildChan(chan,section){if(section=section||chan.section,!section)return console.error('No section specified for buildChan()');var ballSrc=chan.ball||'/chans/balls/'+section+'/'+('drafts'==section?'no-ball':chan.id)+'.png?uid='+chan._id+(chan.ballv?'&v='+chan.ballv:''),search=(chan.id+' '+chan.name+' '+chan.url.replace(/^https?:\/\//,'')+' '+(chan.wiki||'').replace(/^https?:\/\//,'')).toLowerCase().trim().replace(/[<>""]/g,''),dlbtn='drafts'===section?'\n\t\t<button class="btn export-draft">\n\t\t\t<svg class="icon" title="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A"><use xlink:href="#i-download"></use></svg>\n\t\t</button>':'',htm=escHTML(_templateObject12,section,chan.name?'':' no-name',chan.id,search,ballSrc,chan.name||'\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438')+dlbtn+'\n\t\t</li>',$chan=$(htm);return chan.section=section,$chan[0]._libdata=chan,$chan},addChan:function addChan(chan,section,fresh){if('undefined'==typeof fresh&&(fresh=!1),section=section||chan.section,!section)return console.error('No section specified for addChan()');var $chan=this.buildChan(chan,section);$chan.appendTo('#chans'),fresh&&this.highlight($chan);var libdata=$chan[0]._libdata;return libdata},editChan:function editChan(chan){var $chan=$(jq(_templateObject13,chan.id)),libdata=$chan[0]._libdata;return _.assign(libdata,chan),$chan.replaceWith(this.buildChan(libdata,libdata.section)),this.highlight($(jq(_templateObject13,chan.id))),libdata},deleteChan:function deleteChan(id){$(jq(_templateObject13,id)).remove()},highlight:function highlight($chan){var sect=$chan[0]._libdata.section;$(jq(_templateObject14,sect)).click(),$chan.addClass('fresh'),toggleLib(!0)}},libchan={load:function load(chan){upForm.toggle(),this.current=chan,this.current.default=+('default'==chan.section),this.current.included=+chan.included,this.setMode('edit',chan.section),$('#chan-id').val(chan.id),$('#chan-name').val(chan.name).trigger('input'),$('#chan-url').val(chan.url),$('#chan-wiki').val(chan.wiki||''),$('#chan-userboards').val(chan.userboards||''),$('#chan-userboards_catname').val(chan.userboards_catname||'2.0'),$('#chan-userboards_system').val(chan.userboards_system||'instant'),ball.setBall(chan);var offset=chan.offset||[0,0];$('#position-tweak-left').val(offset[0]),$('#position-tweak-top').val(offset[1]),ball.offset(),$('#bgc-from')[0].jscolor.fromString(chan.catbg[0]),$('#bgc-to')[0].jscolor.fromString(chan.catbg[1]),gradient.update(),$('#chan-prefix').val(chan.prefix||''),$('#chan-postfix').val(chan.postfix||''),tree.build(chan.boards),$('#custom-css').prop('checked',!!chan.colors),chan.colors?($('#color-theme').show(),$('#bgColor')[0].jscolor.fromString(chan.colors[0]),$('#linkColor')[0].jscolor.fromString(chan.colors[1]),chan.advanced_less?($('#advance-less').prop('checked',1).trigger('change'),$('#less-enter').val(lessFormatter.prettify(chan.advanced_less))):($('#less-enter').val(lessFormatter.prettify(styles.base)),$('#advance-less').prop('checked',0).trigger('change')),styles.update()):styles.reset(),chan.radio?($('#radio-editor').show(),radio.build(chan.radio),$('#radio').prop('checked',!0)):radio.reset(),$('#default').prop('checked','default'===chan.section),$('#included').prop('checked',!!chan.included),this.rinse()},_schema:{integrity:{required:['id','name','url','boards','ball','offset','catbg'],optional:['userboards','prefix','postfix','wiki','radio','colors','advanced_less','userboards_catname','userboards_system'],adminOnly:['default','included']},specialComps:{pairs:['catbg','offset','colors'],objects:['boards','radio'],isNewBall:['ball']},conversions:{toFile:['ball']},defaults:{"":['userboards','prefix','postfix','wiki'],"FFFFFF|FFFFFF":['catbg'],"0|0":['offset'],"2C333D|37C999":['colors'],"2.0":['userboards_catname'],instant:['userboards_system']},fns:{objects:_.eq.bind(_),pairs:function pairs(first,second){var vals=[first,second].map(function(val){return val instanceof Array?val.join('|').toLowerCase():val});return vals[0]===vals[1]},isNewBall:function isNewBall(cur,nu){return cur?nu===cur:'default'===nu},toFile:function toFile(v){return 0===v.indexOf('data:')?v.toBlob():v}}},init:function init(){var _this19=this,schema={};_.each(this._schema.integrity,function(props,intCls){props.forEach(function(prop){schema[prop]={},schema[prop][intCls]=!0,'optional'===intCls&&(schema[prop].default=null)})}),_.each(this._schema.specialComps,function(props,cmpCls){props.forEach(function(prop){schema[prop].eqFn=_this19._schema.fns[cmpCls]})}),_.each(this._schema.conversions,function(props,convCls){props.forEach(function(prop){schema[prop].conv=_this19._schema.fns[convCls]})}),_.each(this._schema.defaults,function(props,defCls){props.forEach(function(prop){schema[prop].default=defCls})}),this.schema=schema},mode:'new',setMode:function setMode(mode,section){this.mode=mode,$('body').toggleClass('edit-draft','edit'===mode&&'drafts'===section),$('#chan-id, #save-draft').prop('disabled','edit'===mode&&'drafts'!==section),$('#clone-this, #delete-this').prop('disabled','new'===mode)},rinse:function rinse(){$('.tipper').setTipperState('question'),$('input').removeClass('invalid')},collectData:function collectData(role){var isDraft='draft'===role;return new Promise(function(resolve,reject){var chan={},dataPromises=[];if(['url','name','id','wiki','userboards','userboards_catname','prefix','postfix'].forEach(function(prop){var pr=$(jq(_templateObject15,prop))[0].validate(0,isDraft).then(function(val){chan[prop]=val});dataPromises.push(pr)}),dataPromises.push(ball.getData(isDraft).then(function(data){_.assign(chan,data)})),dataPromises.push(new Promise(function(resolve,reject){var treeToUI=tree.toggleView('UI',isDraft);if(treeToUI)resolve(treeToUI);else if(!1===treeToUI)reject();else{var validUI=tree.validateUI(isDraft);validUI?resolve(validUI):reject()}chan.boards=!1!==tree.toggleView('UI')&&tree.validateUI()}).then(function(data){chan.boards=data})),chan.userboards_system=$('#chan-userboards_system').val(),$('#radio').prop('checked')&&dataPromises.push(radio.getData(isDraft).then(function(data){chan.radio=data})),$('#custom-css').prop('checked')&&dataPromises.push(styles.getData(isDraft).then(function(data){_.assign(chan,data)})),IS_ADMIN){var admy={};['default','included'].forEach(function(prop){admy[prop]=+$(jq(_templateObject,prop)).prop('checked')}),_.assign(chan,admy)}Promise.all(dataPromises).then(function(){return resolve(chan)},function(){return reject('fix-errors')})})},proceedWithData:function proceedWithData(role,isUpload){var _this20=this,mode=isUpload&&this.current&&'drafts'===this.current.section?'new':this.mode;return new Promise(function(resolve,reject){var fd=new FormData,chan={},errors=[];_this20.collectData(role).then(function(data){'edit'===mode&&libchan.current.id!==data.id&&errors.push('id-changed'),_.each(_this20.schema,function(propSchema,prop){var val;if(!propSchema.adminOnly||IS_ADMIN){if(data.hasOwnProperty(prop)?val=data[prop]:propSchema.required?errors.push('fill-required-fields'):val=null,'edit'===mode&&'id'!==prop){var cur=libchan.current.hasOwnProperty(prop)?libchan.current[prop]:propSchema.default;if(propSchema.eqFn?propSchema.eqFn(cur,val):cur===val)return}else if(null===val)return;chan[prop]=val,'upload'===role&&(propSchema.conv&&(val=propSchema.conv(val)),fd.apnd(prop,val))}}),errors.length?reject(_.uniq(errors)):(DO_DEBUG&&console.log(chan),resolve({obj:chan,fd:fd}))},function(errors){reject(errors)})})},clone:function clone(){this.setMode('new'),ball.toDataURL(),$('#chan-id').val(''),$('#chan-name')[0].value+=' (\u043A\u043B\u043E\u043D)',$('#chan-name').trigger('input')},clear:function clear(){['url','name','id','wiki','userboards','prefix','postfix'].forEach(function(field){return $(jq(_templateObject15,field)).val('')}),$('#chan-userboards_catname').val('2.0'),ball.clear(),['from','to'].forEach(function(field){return $(jq(_templateObject3,field))[0].jscolor.fromString('ffffff')}),gradient.update(),[radio,styles].forEach(function(w){return w.reset()}),tree.build('[]'),tree.toggleView('UI'),this.rinse(),this.current=null,this.setMode('new'),upForm.toggle()}},drafts={model:[],load:function load(){var lsDrafts=localStorage.mydrafts;if(lsDrafts)try{var parsed=JSON.parse(lsDrafts);if('object'!==('undefined'==typeof parsed?'undefined':_typeof(parsed))||!parsed.hasOwnProperty('chans'))throw new Error;this.model=parsed.chans}catch(e){console.error('Drafts in localStorage are corrupted and will be purged'),localStorage.removeItem('mydrafts')}library.build(this.model,'drafts')},remove:function remove(id){this.model.splice(_.findIndex(this.model,{id:id}),1),library.deleteChan(id),libchan.setMode('new'),this.sync()},add:function add(chan){var libdata=library.addChan(chan,'drafts',1);this.model.push(chan),libchan.current=libdata,libchan.setMode('edit','drafts')},edit:function edit(chan){var edited=library.editChan(chan);this.model[_.findIndex(this.model,{id:chan.id})]=edited},sync:function sync(){localStorage.mydrafts=JSON.stringify({chans:this.model,version:new Date().getTime()})},submit:function submit(){var _this21=this,newid=$('#chan-id').val();if('edit'===libchan.mode&&libchan.current.id!==newid)return $('#id-to-change').text(libchan.current.id),void upForm.toggle('prompt pr-idchanged');if('new'===libchan.mode&&_.find(this.model,{id:newid})){$('#id-to-overwrite').text(newid);var guro=/(.+?)(\d+)$/.exec(newid);return $('#proposed-id').text(guro?''+guro[1]+(+guro[2]+1):newid+'2'),void upForm.toggle('prompt pr-idexists')}upForm.toggle();libchan.proceedWithData('draft').then(function(res){var draft=res.obj;'edit'===libchan.mode?_this21.edit(draft):_this21.add(draft),_this21.sync()},function(errors){upForm.showErrors(errors)})}};libchan.init();var lessFormatter={minify:function minify(less){return less.replace(/\n/g,' ').replace(/\s{2,}/g,' ').trim()},prettify:function prettify(less){return css_beautify(this.minify(less).replace(/([;{}])/g,'$1\n').replace(/^\s+/gm,'').trim(),{indent_char:'\t',indent_size:1,newline_between_rules:!1})}},validations={urlencode:function urlencode(val){return encodeURI(val)},checkuniq:function checkuniq(val,prop){return new Promise(function(resolve,reject){return'edit'===libchan.mode&&libchan.current[prop]===val?void resolve():void $.get('api.php?checkuniq&prop='+prop+'&val='+encodeURIComponent(val)).then(function(data){data.error?reject('occupied'):resolve()}).fail(function(er){console.error('XHR error during post-validation',er),reject('XHR error')})})}};NodeList.prototype.forEach=Array.prototype.forEach,NodeList.prototype.map=Array.prototype.map,FormData.prototype.apnd=function(k,v){'object'!==('undefined'==typeof v?'undefined':_typeof(v))||v instanceof Blob?this.append(k,v):this.append(k,JSON.stringify(v))},FormData.prototype.inspect=function(){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,pair,_iterator=this.entries()[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)pair=_step.value,console.log(pair[0]+' = '+pair[1])}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},Blob.prototype.readAsDataURL=function(callback){var fr=new FileReader;fr.onload=function(ev){return callback(ev.target.result)},fr.readAsDataURL(this)},String.prototype.toBlob=function(){try{for(var arr=this.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);n--;)u8arr[n]=bstr.charCodeAt(n);return new Blob([u8arr],{type:mime})}catch(e){return console.error(e),!1}};function getDataUri(url,callback){var image=new Image;image.onload=function(){var canvas=document.createElement('canvas');canvas.width=this.naturalWidth,canvas.height=this.naturalHeight,canvas.getContext('2d').drawImage(this,0,0),callback(canvas.toDataURL('image/png'))},image.src=url}function mixedRange(input){for(var m,output=[],re=/(?:([0-9]+)(?:\-([0-9]+))?(?:, ?)?)/g;null!==(m=re.exec(input));)m.index===re.lastIndex&&re.lastIndex++,m[2]?output=output.concat(_.range(m[1],+m[2]+1)):output.push(+m[1]);return output}var upForm={$form:null,init:function init(){var _this22=this;this.$form=$('#upload-form').on('submit',this.submit.bind(this)),_.each(this.actorFieldMap,function(fields,actor){fields.forEach(function(field){return _this22.fieldActorMap[field]=actor})})},toggle:function toggle(type){if(!type)this.$form.removeClass('expanded');else{this.$form.removeClass('f-upload f-delete f-prompt pr-idchanged pr-idexists').addClass('f-'+type+' expanded');var draftDelete=libchan.current&&'drafts'===libchan.current.section&&'delete'===type;$('#upload-form input').prop('required',!draftDelete),!draftDelete&&$('.captcha').hasClass('not-loaded')&&refreshCaptcha()}},checkFields:function checkFields(){return $('#pswd').val()&&$('#captcha').val()},submit:function submit(ev){var _this23=this;ev.preventDefault();var action=this.$form.hasClass('f-delete')?'delete':'upload';if(libchan.current&&'drafts'===libchan.current.section&&'delete'==action)return drafts.remove(libchan.current.id),void this.toggle();if(!this.checkFields())return this.showErrors('fill-required-fields');if(this.$form.addClass('busy'),'upload'==action)libchan.proceedWithData(action,!0).then(function(res){_this23.candidate=res.obj,_this23.send(libchan.mode,res.fd)},function(errors){_this23.showErrors(errors),_this23.$form.removeClass('busy')});else{var fd=new FormData;$('#chan-id')[0].validate(1).then(function(id){fd.apnd('id',id),_this23.candidate={id:id},_this23.send('delete',fd)},function(e){return console.error(e)})}},send:function send(action,fd){libchan.current&&'drafts'===libchan.current.section&&(action='new'),fd.apnd('action',action),fd.apnd('captcha',$('#captcha').val()),fd.apnd('password',$('#pswd').val()),DO_DEBUG&&fd.inspect();var request=new XMLHttpRequest;request.open('POST','api.php'),request.send(fd);var _this=this;request.onload=function(e){if(200==this.status){var res=0;try{res=JSON.parse(this.response)}catch(e){console.error(e),console.warn(this.response),_this.unbusy(),_this.showErrors('invalid-response')}res&&_this.handleResponse(res)}else _this.unbusy(),_this.showErrors('xhr-error'),console.error(e)}},showErrors:mkErrorShower('submit'),errorDescriptors:{"fill-required-fields":'\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u044B\u0435 \u043F\u043E\u043B\u044F',"xhr-error":'\u041E\u0448\u0438\u0431\u043A\u0430 XHR. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.',"invalid-response":'\u041E\u0448\u0438\u0431\u043A\u0430 XHR (\u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u043E\u0442\u0432\u0435\u0442\u0430). \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.',"id-changed":'ID \u0431\u044B\u043B \u043D\u0435\u043B\u0435\u0433\u0430\u043B\u044C\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D.',"nothing-to-edit":'\u041D\u0435\u0447\u0435\u0433\u043E \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C',missing:'\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u043F\u0430\u0440\u043E\u043B\u044C',"wrong-captcha":'\u041A\u0430\u043F\u0447\u0430 \u0432\u0432\u0435\u0434\u0435\u043D\u0430 \u043D\u0435\u0432\u0435\u0440\u043D\u043E',"wrong-password":'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C',"fix-errors":'\u0418\u0441\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u043E\u0448\u0438\u0431\u043A\u0438!',"db-error":'\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u0438\u0441\u0438 \u0432 \u0411\u0414',"not-admin":'\u041D\u0435\u043F\u043E\u0445\u043E\u0436\u0435, \u0447\u0442\u043E \u0432\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440',"wrong-value":'\u041D\u0435\u0432\u0435\u0440\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435',"chan-does-not-exist":'\u0417\u0430\u043F\u0438\u0441\u044C \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0411\u0414'},actorFieldMap:{ball:['ball','catbg','offset'],styles:['colors','advanced_less'],tree:['boards'],radio:['radio'],admin:['admin']},fieldActorMap:{},unbusy:function unbusy(){this.$form.removeClass('busy'),refreshCaptcha()},handleResponse:function handleResponse(res){var _this24=this;if(this.unbusy(),res.error){var errors=res.error;errors instanceof Array||(errors=[errors]),errors=errors.map(function(err){if(!err.field)err={field:_this24,msg:err};else{var $input=$(jq(_templateObject15,err.field));err.field=$input.length&&$input[0].showErrors?$input[0]:_this24.fieldActorMap.hasOwnProperty(err.field)?window[_this24.fieldActorMap[err.field]]:_this24}return err});var fields=_.uniq(_.pluck(errors,'field'));_.includes(fields,this)||(errors.push({field:this,msg:'fix-errors'}),fields.push(this)),fields.forEach(function(field){var messages=_.pluck(_.filter(errors,{field:field}),'msg').map(function(msg){return _this24.errorDescriptors[msg]||msg});field.showErrors(_.uniq(messages))})}else{if(this.showErrors([]),'new-success'===res.action){drafts.remove(upForm.candidate.id),delete this.candidate.ball;var sect=this.candidate.section&&'default'===this.candidate.section?'default':'custom',added=library.addChan(this.candidate,sect,!0);libchan.load(added),console.log(upForm.candidate.id,this.candidate,sect)}if('edit-success'===res.action){res.moveto&&(this.candidate.section=res.moveto);var edited=library.editChan(this.candidate);libchan.load(edited)}'delete-success'===res.action&&(library.deleteChan(this.candidate.id),libchan.setMode('new','draft')),this.toggle()}}},DO_DEBUG=!1;function makeEscapeTagLiteralFn(){var fn=0<arguments.length&&arguments[0]!==void 0?arguments[0]:function(v){return v};return function(strings){for(var result='',i=0;i<strings.length;i++)result+=strings[i],i<(1>=arguments.length?0:arguments.length-1)&&(result+=fn(''+(arguments.length<=i+1?void 0:arguments[i+1])));return result}}var jq=makeEscapeTagLiteralFn(function(v){return v.replace(/([!"#$%&'()*+,\-./:;<=>?@[\\\]^`{|}~ ])/g,'\\$1')}),escHTML=makeEscapeTagLiteralFn(_.escape);function LSfetchJSON(key){var val=null,data=localStorage[key];if('undefined'!=typeof data)try{val=JSON.parse(data)}catch(e){console.error(e),localStorage.removeItem(key)}return val}function downloadJSON(obj,name){var dlAnchorElem=document.getElementById('dl-victim');dlAnchorElem.setAttribute('href','data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(obj))),dlAnchorElem.setAttribute('download',name+'.json'),dlAnchorElem.click()}
//# sourceMappingURL=editor.js.map