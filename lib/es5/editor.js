"use strict";var _templateObject=_taggedTemplateLiteral(["#",""],["#",""]),_templateObject2=_taggedTemplateLiteral(["#position-tweak-",""],["#position-tweak-",""]),_templateObject3=_taggedTemplateLiteral(["#bgc-",""],["#bgc-",""]),_templateObject4=_taggedTemplateLiteral(["<li class=\"cat-brd ","\">\n\t\t<input type=\"text\" class=\"board-dir\" value=\"","\">\n\t\t<input type=\"text\" class=\"board-desc\" value=\"","\">\n\t\t<div class=\"dragger\" title=\"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438\"><svg class=\"b-option icon\"><use xlink:href=\"#i-drag\"></use></svg></div>\n\t\t<button class=\"b-option delb delboard\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443\"><svg class=\"icon\"><use xlink:href=\"#i-x\"></use></svg></button>\n\t</li>"],["<li class=\"cat-brd ","\">\n\t\t<input type=\"text\" class=\"board-dir\" value=\"","\">\n\t\t<input type=\"text\" class=\"board-desc\" value=\"","\">\n\t\t<div class=\"dragger\" title=\"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438\"><svg class=\"b-option icon\"><use xlink:href=\"#i-drag\"></use></svg></div>\n\t\t<button class=\"b-option delb delboard\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443\"><svg class=\"icon\"><use xlink:href=\"#i-x\"></use></svg></button>\n\t</li>"]),_templateObject5=_taggedTemplateLiteral(["#tree .invalid.inv_",""],["#tree .invalid.inv_",""]),_templateObject6=_taggedTemplateLiteral(["#","-tipper"],["#","-tipper"]),_templateObject7=_taggedTemplateLiteral(["","","",""],["","","",""]),_templateObject8=_taggedTemplateLiteral(["#","Color"],["#","Color"]),_templateObject9=_taggedTemplateLiteral(["<li class=\"stream","\">\n\t\t<input type=\"text\" class=\"stream-name\" placeholder=\"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"20\" value=\"","\">\n\t\t<input type=\"text\" class=\"stream-range\" placeholder=\"\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D\" title=\"\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D\" maxlength=\"20\" value=\"","\">\n\t\t<div class=\"stream-options\">\n\t\t\t<button class=\"b-option templatize\" title=\"\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443\"><svg class=\"icon\">\n\t\t\t\t<use class=\"for-templated-hide\" xlink:href=\"#i-template\"></use>\n\t\t\t\t<use class=\"for-templated-show\" xlink:href=\"#i-untemplate\"></use>\n\t\t\t</svg></button>\n\t\t\t<div class=\"dragger\" title=\"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B\"><svg class=\"b-option icon\"><use xlink:href=\"#i-drag\"></use></svg></div>\n\t\t\t<button class=\"b-option delstream\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C\"><svg class=\"icon\"><use xlink:href=\"#i-x\"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type=\"text\" class=\"stream-path\" placeholder=\"/path \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"/path \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"50\" value=\"","\">\n\t\t<input type=\"text\" class=\"stream-mime\" placeholder=\"MIME \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"MIME \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"20\" value=\"","\">\n\t</li>"],["<li class=\"stream","\">\n\t\t<input type=\"text\" class=\"stream-name\" placeholder=\"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"20\" value=\"","\">\n\t\t<input type=\"text\" class=\"stream-range\" placeholder=\"\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D\" title=\"\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D\" maxlength=\"20\" value=\"","\">\n\t\t<div class=\"stream-options\">\n\t\t\t<button class=\"b-option templatize\" title=\"\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443\"><svg class=\"icon\">\n\t\t\t\t<use class=\"for-templated-hide\" xlink:href=\"#i-template\"></use>\n\t\t\t\t<use class=\"for-templated-show\" xlink:href=\"#i-untemplate\"></use>\n\t\t\t</svg></button>\n\t\t\t<div class=\"dragger\" title=\"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B\"><svg class=\"b-option icon\"><use xlink:href=\"#i-drag\"></use></svg></div>\n\t\t\t<button class=\"b-option delstream\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C\"><svg class=\"icon\"><use xlink:href=\"#i-x\"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type=\"text\" class=\"stream-path\" placeholder=\"/path \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"/path \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"50\" value=\"","\">\n\t\t<input type=\"text\" class=\"stream-mime\" placeholder=\"MIME \u0441\u0442\u0440\u0438\u043C\u0430\" title=\"MIME \u0441\u0442\u0440\u0438\u043C\u0430\" maxlength=\"20\" value=\"","\">\n\t</li>"]),_templateObject10=_taggedTemplateLiteral(["#streams .invalid.inv_",""],["#streams .invalid.inv_",""]),_templateObject11=_taggedTemplateLiteral([".stream-",""],[".stream-",""]),_templateObject12=_taggedTemplateLiteral(["<li class=\"lib-chan sect-","","\" id=\"chan_","\" data-search=\"","\">\n\t\t\t<img src=\"","\" class=\"lib-chanball\">\n\t\t\t<div class=\"chan-title\">","</div>"],["<li class=\"lib-chan sect-","","\" id=\"chan_","\" data-search=\"","\">\n\t\t\t<img src=\"","\" class=\"lib-chanball\">\n\t\t\t<div class=\"chan-title\">","</div>"]),_templateObject13=_taggedTemplateLiteral(["#chan_",""],["#chan_",""]),_templateObject14=_taggedTemplateLiteral([".tab[data-tab=","]"],[".tab[data-tab=","]"]),_templateObject15=_taggedTemplateLiteral(["#chan-",""],["#chan-",""]);function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _taggedTemplateLiteral(a,b){return Object.freeze(Object.defineProperties(a,{raw:{value:Object.freeze(b)}}))}var IS_ADMIN=!1,main=function(){function a(){return libchan.setMode("new","drafts"),drafts.submit(1),!1}LSfetchJSON("IS_ADMIN")&&(IS_ADMIN=!0,$("body").addClass("is-admin")),$("#chan-library").toggleClass("expanded",1==localStorage["chanlib-expanded"]),setTimeout(function(){return injector.inject("lib-collapse",".collapsible-content {  transition: width 0.3s; }")},100),$.ajaxSetup({dataType:"json"}),$(".tipper").each(function(){$(this).prepend("\n\t\t\t<svg class=\"icon t-i-q\"><use xlink:href=\"#i-question\"></use></svg>\n\t\t\t<svg class=\"icon t-i-e\"><use xlink:href=\"#i-warning\"></use></svg>\n\t\t\t<svg class=\"icon t-i-s spinning\"><use xlink:href=\"#i-spinner\"></use></svg>\n\t\t\t<svg class=\"icon t-i-ok\"><use xlink:href=\"#i-check\"></use></svg>")}).append("<div class=\"tooltip-wrap error-msg\"><div class=\"tooltip\"></div></div>"),$(".validable").each(function(){var a=this,b=$(this).parents(".tip-container").find(".tipper");this.showErrors=mkErrorShower(b),this.errorDescriptors={"too-long":"\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0434\u043B\u0438\u043D\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F","too-short":"\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F",invalid:"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0430\u043D\u043D\u044B\u0445",missing:"\u041F\u043E\u043B\u0435 \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E \u0434\u043B\u044F \u0432\u0432\u043E\u0434\u0430",occupied:"\u0417\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0437\u0430\u043D\u044F\u0442\u043E"},$(this).attr("pattern")&&(this.patternRX=new RegExp($(this).attr("pattern"))),this.validate=function(c,d){return new Promise(function(e,f){var g=$(a),h=g.val(),i=[];if(h=h.trim(),g.val(h),h){var l=g.attr("maxlength"),m=g.attr("minlength");m&&h.length<m&&i.push("\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F (\u043D\u0443\u0436\u043D\u043E \u043C\u0438\u043D\u0438\u043C\u0443\u043C ".concat(m," \u0441\u0438\u043C\u0432.)")),a.patternRX&&!h.match(a.patternRX)&&i.push("invalid");var n=g.data("valconvert");n&&validations.hasOwnProperty(n)&&(h=validations[n](h)),l&&h.length>l&&i.push("\u041F\u0440\u0435\u0432\u044B\u0448\u0435\u043D\u0430 \u043C\u0430\u043A\u0441. \u0434\u043B\u0438\u043D\u0430 \u043F\u043E\u043B\u044F (".concat(l," \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432)"))}else $(a).prop("required")&&i.push("missing");var j=function(){c||a.showErrors(i),i.length?d?e(h):f(i):(b.setTipperState("valid"),e(h))},k=g.data("aftervalid");i.length?j():(b.setTipperState("spinner"),k&&validations[k]?validations[k](h,g.data("uniq")).then(function(){return j()},function(a){i.push(a),j()}):j())})}}).on("focus",function(){var a=$(this),b=a.parents(".tip-container"),c=b.find(".tipper")}),$(".validable:not(.no-val-onblur)").on("blur",function(){this.validate().then(_.noop,_.noop)}),$("#color-selector .colorbox").change(gradient.update.bind(gradient)),$("#change-direction").click(function(){var a=$(this).find("use"),b=0>a.attr("transform").indexOf("-90");a.attr("transform","rotate(".concat(b?"-":"","90 8 8)"));var c=$("#bgc-from")[0],d=$("#bgc-to")[0],e=[d.id,c.id];c.id=e[0],d.id=e[1],gradient.update()}),$("body").on("click",".add-board",function(){tree.addBoard($(this))}).on("click",".delboard",function(){tree.removeBoard($(this))}).on("click",".delcat",function(){var a=$(this).parents(".tree-cat");a.hasClass("predelete")||a.hasClass("empty")?tree.removeCategory($(this)):a.addClass("predelete")}).on("click",".cat-undelete",function(){$(this).parents(".tree-cat").removeClass("predelete")}).on("click",".f-minus, .f-plus",function(){$(this).parents(".tree-cat").toggleClass("hidden")}).on("click",".add-cat",tree.addCategory.bind(tree)).on("input",".board-dir",function(){$(this).parents(".cat-brd").toggleClass("external",!!$(this).val().match(/^https?:\/\//))}).on("mouseup mouseleave blur touchend touchcancel",function(){b=!1}).on("click",".delstream",function(){radio.removeStream($(this))}).on("click",".templatize",function(){$(this).parents(".stream").toggleClass("templated").find(".stream-range").focus()}).on("blur","#tree input",tree.validateUI.bind(tree)).on("click",".lib-chan",function(){libchan.load(this._libdata)}).on("dragenter dragend dragover drop dragleave",function(a){a.preventDefault(),a.stopPropagation()}).on("dragenter",function(){$(this).addClass("dropping"),clearTimeout(this.offTimeout)}).on("dragend drop dragleave",function(a){var b=this;a.currentTarget===a.target&&(this.offTimeout=setTimeout(function(){$(b).removeClass("dropping")},100))}).on("click",".export-draft",function(a){a.stopPropagation();var b=$(this).parent(".lib-chan"),c=b[0]._libdata;downloadJSON(c,c.id)}),$(".chanball-wrap").on("dragenter dragend dragover drop dragleave",function(a){a.preventDefault(),a.stopPropagation()}).on("dragenter dragover",function(){$(this).addClass("file-over"),clearTimeout(this.offTimeout)}).on("dragend drop dragleave",function(){var a=this;this.offTimeout=setTimeout(function(){$(a).removeClass("file-over")},100)}).on("drop",ball.handleFile.bind(ball)),$("#radio-editor").on("blur","input",function(){radio.getData().then(_.noop,_.noop)});var b=!1;$(".chanball-dropzone").click(function(){return $("#chanballFileInput").click()}),$("#chanballFileInput").on("change",ball.handleFile.bind(ball)),$("#view-toggle .switch-body").click(function(){return tree.toggleView()}),$("#view-toggle label").click(function(){tree.toggleView($(this).text())}),$("#reup-chanball").click(function(){$("#chanballFileInput").click()}),$(".password-reveal").on("mousedown",function(){$(this).parent().find("input").attr("type","text")}).on("mouseleave mouseup",function(){$(this).parent().find("input").attr("type","password")}),$("#pswd").on("focus",function(){this.removeAttribute("readonly")}).on("blur",function(){this.setAttribute("readonly",!0)}),$(".cb-position-tweaker button").on("mousedown touchstart",function(){var a=this;b=!0;var c=function(c){if(!c&&!b)return clearInterval(a.incrementor);var d=$(a).parent().find("input"),e=+$(a).data("inc");d.val(+d.val()+e),ball.offset()};c(!0),this.incrementor=setInterval(c,150)}).parent().find("input").on("input paste change",ball.offset),$("#tree-json").on("blur",function(){tree.validateJSON()}),$("#chan-name").on("input paste change",function(){$(".channame-overlay").text($(this).val())}),$("#color-theme input.color").change(styles.update.bind(styles)),$("#less-enter").on("input",styles.update.bind(styles)),$("#less-preamble").html(styles.preamble("html")),$("#less-enter").val(styles.base),$(".binded").each(function(){var a=$(this),b=a.data("bind"),c=$(jq(_templateObject,b));c.length&&c.on("input change paste",function(){a.text($(this).val()||"{".concat(b,"}"))}).trigger("change")}),window.updateBindings=function(){$(".binded").each(function(){$(jq(_templateObject,$(this).data("bind"))).trigger("change")})},$("#advance-less").change(function(){var a=$("#less-enter");$(this).prop("checked")?$(".advanced-less").slideDown(function(){a.prop("disabled",0),a[0].preValue&&a.val(a[0].preValue)}):(a[0].preValue=a.val(),a.val(styles.base).prop("disabled",1)),styles.update()}),$(".captcha").click(refreshCaptcha).addClass("not-loaded"),$(".widget-list input").on("change",function(){$(jq(_templateObject,$(this).attr("name"))).toggle($(this).prop("checked"))}),$(".expander").click(function(){$(this).parents(".expandee").toggleClass("expanded")}),$("#onchan").on("change",function(){$(".chan").toggleClass("onchan",$(this).prop("checked"))}),styles.update(),$("#add-stream").click(radio.addStream.bind(radio)),Sortable.create(document.querySelector("#categories"),{handle:".cat-dragger",animation:150}),Sortable.create(document.querySelector("#streams"),{handle:".dragger",animation:150}),$(".sidebar").click(toggleLib);var c="default";$(".tab").click(function(){var a=$(this).data("tab"),b=$("#chan-library"),d=!1;"search"===a?b.hasClass("show-search")?a=c:d=!0:c=a,b.find(".tab").removeClass("selected"),b.find(".tab[data-tab=".concat(a,"]")).addClass("selected"),b.removeClass("show-custom show-default show-drafts show-search").addClass("show-".concat(a)),d&&$("#searchbox").focus()}),$("#searchbox").on("input paste",function(){var a=$(this).val().trim().replace(/\"/g,"\\\"").toLowerCase();a.length?injector.inject("lib-search",".show-search .lib-chan[data-search *= \"".concat(a,"\"] {height: 40px}")):injector.remove("lib-search")}),upForm.init(),$.getJSON("/chans/chans.json?v=".concat(new Date().getTime())).done(function(a){return library.build(a.chans)}),$("#new-chan").click(function(){return libchan.clear()}),$("#clone-this").click(function(){return libchan.clone()}),$("#publish").click(function(){return upForm.toggle("upload")}),$("#delete-this").click(function(){return upForm.toggle("delete")}),$("#save-draft").click(function(){return drafts.submit()}),$("#draft-saveasnew").click(a),$("#draft-changeid").click(function(){drafts.remove(libchan.current.id),a()}),$("#draft-savemodifiedid").click(function(){return $("#chan-id").val($("#proposed-id").text()),drafts.submit(),!1}),$("#draft-overwrite").click(function(){return drafts.remove($("#id-to-overwrite").text()),drafts.submit(),!1}),drafts.load()};function refreshCaptcha(){$(".captcha").attr("src","/captcha.php?color=255,255,255&v=".concat(Math.random())).removeClass("not-loaded"),$("#captcha").val("")}function toggleLib(a){$("#chan-library").toggleClass("expanded",a),localStorage["chanlib-expanded"]=+$("#chan-library").hasClass("expanded")}var gradient={make:function d(a,b,c){return"radial"===a?"radial-gradient(ellipse at center, ".concat(b," 0%, ").concat(c," 100%)"):"linear-gradient(to ".concat(a,", ").concat(b," 0%, ").concat(c," 100%)")},prefixify:function g(a){var b=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(a);if(null===b)return"background:"+a;b=_.rest(_.without(b,void 0));var c,d=b[0]+"; ",e=b[1];c=isNaN(b[2])?"bottom"==b[2]?"top, ":"right"==b[2]?"left, ":"center, ellipse cover, ":90-parseFloat(b[2])+"deg, ";var f=b[3];return _.each(["-o-","-webkit-","-moz-"],function(a){d+="background:"+a+e+"("+c+f+"); "}),"background:"+d},getValue:function c(){var a="#"+$("#bgc-from").val(),b="#"+$("#bgc-to").val();return this.make("bottom",a,b)},update:function b(){var a=this.getValue();injector.inject("chanball-background",".chanball-wrap { ".concat(this.prefixify(a)," }"))}},injector={inject:function g(a,b){var c="injector:".concat(a),d=document.getElementById(c);if(d)return void(d.innerHTML=b);var e=document.head||document.getElementsByTagName("head")[0],f=document.createElement("style");f.type="text/css",f.id=c,f.styleSheet?f.styleSheet.cssText=b:f.appendChild(document.createTextNode(b)),e.appendChild(f)},remove:function e(a){var b="injector:".concat(a),c=document.getElementById(b);if(c){var d=document.head||document.getElementsByTagName("head")[0];d&&d.removeChild(document.getElementById(b))}}},ball={handleFile:function e(a){a.stopPropagation(),a.preventDefault(),a=a.originalEvent,$("body").removeClass("dropping");var b="drop"==a.type?a.dataTransfer.files:a.target.files,c=b[0];if(c&&"image/png"==c.type){var d=new FileReader;d.onload=function(){return function(a){this.setBall(a.target.result)}.bind(this)}.bind(this)(c),d.readAsDataURL(c)}else c&&this.showErrors("image-not-png")},setBall:function e(a){var b,c=this;if("string"==typeof a)b=a;else if(!!a.ball)b=a.ball;else if("drafts"!==a.section)b="/chans/balls/".concat(a.section,"/").concat(a.id,".png?uid=").concat(a._id).concat(a.ballv?"&v=".concat(a.ballv):"");else return void this.clear();var d=$("#chanball").attr("src",b);d.one("load",function(){200<d.width()||200<d.height?c.showErrors("image-too-large"):(c.file=b,c.fType=0===b.indexOf("data:")?"dataURL":"file",c.showErrors([]),$("#chanball-sect").addClass("chanball-present"))}),gradient.update()},clear:function a(){$("#chanball-sect").removeClass("chanball-present"),this.file=null},getData:function c(a){var b=this;return new Promise(function(c,d){var e=[];b.file||e.push("no-file");var f=["left","top"].map(function(a){var b=$(jq(_templateObject2,a)),c=+b.val();return isNaN(c)&&(c=0),100<Math.abs(c)&&(c=100*Math.sign(c)),b.val(c),c}),g=["from","to"].map(function(a){var b=$(jq(_templateObject3,a)),c=b.val();return c.match(/[0-9a-f]{6}/i)||(c="ffffff",b[0].jscolor.fromString(c)),c});b.offset(),gradient.update(),b.showErrors(e),e.length&&!a?d(e):c({ball:"file"===b.fType?"default":b.file,offset:f,catbg:g})})},toDataURL:function b(){var a=this;"data"!=this.fType&&this.file&&getDataUri(this.file,function(b){a.file=b,a.fType="data"})},errorDescriptors:{"no-file":"\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442","image-not-png":"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0442\u0438\u043F \u0444\u0430\u0439\u043B\u0430 (\u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C PNG)","image-too-large":"\u0420\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430 \u043D\u0435 \u0434\u043E\u043B\u0436\u0435\u043D \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 200 \u043F\u043A\u0441","upload-error":"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u0438\u0438 \u0444\u0430\u0439\u043B\u0430"},file:null,fType:null,offset:function c(){var a=+$("#position-tweak-top").val(),b=+$("#position-tweak-left").val();return $("#chanball").css({transform:"translate(".concat(b,"px, ").concat(a,"px)"),"-webkit-transform":"translate(".concat(b,"px, ").concat(a,"px)"),"-ms-transform":"translate(".concat(b,"px, ").concat(a,"px)"),"-moz-transform":"translate(".concat(b,"px, ").concat(a,"px)"),"-o-transform":"translate(".concat(b,"px, ").concat(a,"px)")}),[a,b]},showErrors:mkErrorShower("ball")},tree={build:function d(a){var b=this,c="";if(a){if("string"==typeof a)try{a=JSON.parse(a)}catch(b){return this.toggleView("JSON",!0),void $("#tree-json").val(a)}a.length&&this.isFlat(a)&&(a=[{name:"",boards:a}]),a.forEach(function(a){c+=b.buildCat(a)})}return $("#categories").html(c),document.querySelectorAll(".tree-cat ul").forEach(this.makeBoardsSortable.bind(this)),$("#tree-json").val(JSON.stringify(this.deconstruct(),null,"\t")),this.validateUI()},isFlat:function b(a){return a[0].hasOwnProperty("dir")},boardHeight:24,addBoardButtonHeight:27,buildCat:function e(a){a.boards=a.boards||[];var b=this.buildBoards(a.boards),c=0===a.boards.length,d=(a.boards.length+1)*this.boardHeight+this.addBoardButtonHeight;return"<div class=\"tree-cat ".concat(c?"empty":"","\">\n\t\t<div class=\"tree-cathead\">\n\t\t\t<svg class=\"icon f-plus\" title=\"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C\"><use xlink:href=\"#i-folder-plus-fill\"></use></svg>\n\t\t\t<svg class=\"icon f-minus\" title=\"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C\"><use xlink:href=\"#i-folder-minus-fill\"></use></svg>\n\t\t\t<svg class=\"icon f-empty\"><use xlink:href=\"#i-folder-empty\"></use></svg>\n\t\t\t<input type=\"text\" class=\"cat-title\" value=\"").concat(_.escape(a.name)||"","\"></input>\n\t\t\t<button class=\"b-option cat-undelete\" title=\"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0435\">\n\t\t\t\t<svg class=\"icon\"><use xlink:href=\"#i-undo\"></use></svg>\n\t\t\t</button>\n\t\t\t<div class=\"cat-dragger\" title=\"\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438\">\n\t\t\t\t<svg class=\"b-option icon\"><use xlink:href=\"#i-drag\"></use></svg>\n\t\t\t</div>\n\t\t\t<button class=\"b-option delb delcat\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E\">\n\t\t\t\t<svg class=\"icon\"><use xlink:href=\"#i-x\"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class=\"tree-catboards\" style=\"max-height: ").concat(d,"px\">").concat(b,"</div></div>")},buildBoards:function d(a){var b=this,c="<ul>";return a.forEach(function(a){c+=b.buildBoard(a)}),c+="</ul><button class=\"tree-add add-board\" title=\"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443\">\n\t\t\t<div class=\"inner-border\">\n\t\t\t\t<svg class=\"icon\"><use xlink:href=\"#i-slash-plus-slash\"></use></svg>\n\t\t\t</div>\n\t\t</button>",c},buildBoard:function b(a){return escHTML(_templateObject4,a.external?"external":"",a.dir||a.url||"",a.desc||"")},recalcHeight:function d(a){a instanceof jQuery||(a=$(a).parent());var b=a.find(".cat-brd").length,c=(b+1)*this.boardHeight+this.addBoardButtonHeight;a.css({"max-height":"".concat(c,"px")}),a.parent().toggleClass("empty",0==b)},addBoard:function c(a,b){b=b||{},a.parent().find("ul").append(this.buildBoard),this.recalcHeight(a.parent()),a.parent().find(".cat-brd:last input:first").focus()},removeBoard:function c(a){var b=a.parents(".tree-catboards");a.parents(".cat-brd").remove(),this.recalcHeight(b),this.validateUI()},addCategory:function c(a){a.hasOwnProperty("boards")||(a={name:"",boards:[]});var b=$(this.buildCat(a));this.makeBoardsSortable(b.find("ul")[0]),$("#categories").append(b),b.find(".cat-title").focus()},removeCategory:function b(a){a.parents(".tree-cat").remove(),this.validateUI()},makeBoardsSortable:function c(a){var b=this;Sortable.create(a,{handle:".dragger",animation:150,group:"boards",onAdd:function c(a){[a.from,a.to].forEach(b.recalcHeight.bind(b)),b.validateUI()}})},validateJSON:function a(){try{var b=JSON.parse($("#tree-json").val());return this.build(b),1}catch(a){return this.showErrors(a),$("#view-toggle").shake(),0}},validateUI:function i(a){var b=[],c=this.deconstruct();$("#tree .invalid").length&&_.keys(this.errorDescriptors).forEach(function(a){$(jq(_templateObject5,a)).length&&b.push(a)});var d=[],e=function(a){return d.push(a.external?a.url:a.dir)},f=[];c.forEach(function(a){f.push(a.name),a.boards.forEach(e)});var g=findDuplicates(f);if(g.length){b.push("mul-cat");var j=$(".cat-title");g.forEach(function(a){return $(j[a]).addClass("invalid")})}var h=findDuplicates(d);if(h.length){b.push("mul-dir");var k=$(".board-dir");h.forEach(function(a){return $(k[a]).addClass("invalid")})}return this.showErrors(b),(!b.length||a)&&c},deconstruct:function d(){$("#tree .invalid").removeClass("invalid "+_.map(_.keys(this.errorDescriptors),function(a){return"inv_".concat(a)}).join(" "));var a=[],b=$(".tree-cat"),c=!1;return 1==b.length&&(c=!0),$(".tree-cat").each(function(){var b=$(this),d=[],e=b.find(".cat-brd");e.length?e.each(function(){var a=$(this).find(".board-desc"),b=a.val().trim();b||a.addClass("invalid inv_no-desc");var c={desc:b},e=$(this).find(".board-dir"),f=e.val().trim();f||e.addClass("invalid inv_no-dir");var g=!!f.match(/^https?:\/\//);$(this).toggleClass("external",g),c[g?"url":"dir"]=f,g&&(c.external=!0),d.push(c)}):b.addClass("invalid inv_empty-dir");var f=b.find(".cat-title"),g=f.val().trim();c||g||f.addClass("invalid inv_no-name"),a.push({name:g,boards:d})}),a},toggleView:function d(a,b){var c=$("#chan-structure").hasClass("sw_UI")?"UI":"JSON";if("undefined"==typeof a&&(a="UI"==c?"JSON":"UI"),c==a)return null;if("JSON"===a)$("#tree-json").val(JSON.stringify(this.deconstruct(),null,"\t"));else{var e=this.validateJSON();if(b)return $("#tree-json").val();if(!e)return!1}return $("#chan-structure").removeClass("sw_UI sw_JSON").addClass("sw_".concat(a)),1},errorDescriptors:{"no-name":"\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0440\u0430\u0437\u0434\u0435\u043B\u0430","no-dir":"\u041F\u0443\u0441\u0442\u043E\u0439 \u043F\u0443\u0442\u044C \u0434\u043E\u0441\u043A\u0438","no-desc":"\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0434\u043E\u0441\u043A\u0438","mul-dir":"\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0434\u043E\u0441\u043E\u043A","mul-cat":"\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0440\u0430\u0437\u0434\u0435\u043B\u043E\u0432","empty-dir":"\u041F\u0443\u0441\u0442\u043E\u0439 \u0440\u0430\u0437\u0434\u0435\u043B","bad-json":"JSON \u2014 \u0438\u043D\u0432\u0430\u043B\u0438\u0434"},showErrors:mkErrorShower("struct")};function mkErrorShower(a){return function(b){var c=this;b instanceof Array||(b=[b]);var d=a instanceof jQuery?a:$(jq(_templateObject6,a)),e=d.find(".error-msg .tooltip"),f=0<b.length,g=1<b.length,h=(g?"\u041E\u0431\u043D\u0430\u0440\u0443\u0436\u0435\u043D\u044B \u043E\u0448\u0438\u0431\u043A\u0438: <ul>":"")+b.reduce(function(a,b){return a+escHTML(_templateObject7,g?"<li>":"",c.errorDescriptors&&c.errorDescriptors[b]||b,g?"</li>":"")},"")+(g?"</ul>":"");e.html(h),d.setTipperState(f?"error-tip":"question"),f&&d.shake(),this instanceof HTMLElement&&$(this).toggleClass("invalid",f)}}$.fn.shake=function(){var a=this;this.addClass("shake"),setTimeout(function(){return a.removeClass("shake")},900)},$.fn.setTipperState=function(a){this.removeClass(_.without(["question","error-tip","spinner","valid"],a).join(" ")).addClass(a)};function findDuplicates(a){var b=[];return a.forEach(function(c,d){1<a.length-_.without(a,c).length&&b.push(d)}),b}var styles={preamble:function(a){var b=[];return["chan-id","bgColor","linkColor"].forEach(function(c){return b[c]="html"==a?"<span class=\"binded\" data-bind=\"".concat(c,"\"></span>"):$(jq(_templateObject,c)).val()}),"less"==a&&(b["chan-id"]="css-preview"),".chan-".concat(b["chan-id"]," {")+"\n  @bgcolor: #".concat(b.bgColor,";")+"\n  @linkcolor: #".concat(b.linkColor,";")},update:function(a){var b=this;a="function"==typeof a?a:null;var c=this.parseInput();if(!c)return void(a&&a(!1));var d=this.preamble("less")+c+"}";less.render(d).then(function(b){injector.inject("chanclass-preview",b.css),a&&a(!0)},function(c){b.showErrors(c.message),a&&a(!1)})},getData:function(a){var b=this;return new Promise(function(c,d){var e={colors:["bg","link"].map(function(a){var b=$(jq(_templateObject8,a)),c=b.val();return c.match(/[0-9a-f]{6}/i)||(c=b.attr("value"),b[0].jscolor.fromString(c)),c})};$("#advance-less").prop("checked")?(e.advanced_less=lessFormatter.minify($("#less-enter").val()),b.update(function(b){a||b?c(e):d()})):c(e)})},errorDescriptors:{"bracket-imbalance":"\u0421\u043A\u043E\u0431\u043A\u0438 \u043D\u0435 \u0441\u0431\u0430\u043B\u0430\u043D\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u044B"},parseInput:function(){var a=[],b=$("#less-enter").val(),c=b.replace(/\/\*.+?\*\/|".+?"|'.+?'/,"").replace(/[^()\[\]{}]/g,""),d=function(a){for(var b={"]":"[","}":"{",")":"("},c=[],d=!0,e=0,f=a.length;d&&e<f;e++)b[a[e]]?d=c.pop()===b[a[e]]:c.push(a[e]);return d&&!c.length}(c);return d||a.push("bracket-imbalance"),this.showErrors(a),!a.length&&b},showErrors:mkErrorShower("style"),reset:function(){["bg","link"].forEach(function(a){var b=$(jq(_templateObject8,a));b[0].jscolor.fromString(b.data("default"))}),$("#advance-less").prop("checked",0).trigger("change"),this.update(),$("#custom-css").prop("checked",0).trigger("change")},base:"background: @bgcolor;\na, .chan-overlay .icon {\n\tcolor: @linkcolor;\n}\n&:hover {\n\tbackground: darken(@bgcolor, 8%);\n}\n&.onchan {\n\tbox-shadow: inset -2px 0 fadeout(@linkcolor, 25%);\n}\n& when (lightness(@bgcolor) < 70%) {\n\tcolor: #C3C3C3;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: white;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(255, 255, 255, .08);\n\t}\n}\n& when (lightness(@bgcolor) > 70%) {\n\tcolor: #404040;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: black;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(0, 0, 0, .08);\n\t}\n}\n"},radio={buildStream:function b(a){return escHTML(_templateObject9,a.n?" templated":"",a.name||"",a.n||"",a.path||"",a.mime||"")},addStream:function c(a){a=a||{};var b=$(this.buildStream(a));$("#streams").append(b)},build:function c(a){var b=this;$("#chan-radiourl").val(a.url),$("#streams").html(a.streams.reduce(function(a,c){return a+b.buildStream(c)},""))},removeStream:function b(a){return a.parents(".stream").remove()},reset:function a(){this.build({url:"",streams:[]}),$("#radio-editor").hide(),$("#radio").prop("checked",!1)},getData:function c(a){var b=this;return new Promise(function(c,d){var e=function(e,f){f=f?f.map(function(a){return"URL: ".concat(a)}):[],$("#chan-radiourl").toggleClass("invalid",!!f.length),$("#streams input").removeClass("invalid "+_.map(_.keys(b.errorDescriptors),function(a){return"inv_".concat(a)}).join(" "));var g=[],h=$(".stream");h.length?(h.each(function(){var a=$(this),b={};if(["name","path","mime"].forEach(function(c){var d=a.find(".stream-".concat(c)),e=d.val();e||d.addClass("invalid inv_no-".concat(c)),b[c]=e}),g.push(b),a.hasClass("templated")){var c=a.find(".stream-range"),d=c.val();d?mixedRange(d).length?b.n=d:c.addClass("invalid inv_bad-range"):c.addClass("invalid inv_no-range")}}),$("#streams .invalid").length&&_.keys(b.errorDescriptors).forEach(function(a){$(jq(_templateObject10,a)).length&&f.push(a)}),["name","path"].forEach(function(a){var b=findDuplicates(_.pluck(g,a));if(b.length){f.push("mul-".concat(a));var c=$(jq(_templateObject11,a));b.forEach(function(a){return $(c[a]).addClass("invalid")})}})):f.push("no-streams"),b.showErrors(f),!a&&f.length?d(f):c({url:e,streams:g})};$("#chan-radiourl")[0].validate(!0).then(function(a){e(a,null)},function(a){e(null,a)})})},showErrors:mkErrorShower("radio"),errorDescriptors:{"no-streams":"\u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0441\u0442\u0440\u0438\u043C","no-name":"\u041F\u0443\u0441\u0442\u043E\u0435 \u0438\u043C\u044F \u0441\u0442\u0440\u0438\u043C\u0430","no-path":"\u041F\u0443\u0441\u0442\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C","no-mime":"\u041E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 MIME","mul-name":"\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u043E\u0432","mul-path":"\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0441\u0441\u044B\u043B\u043A\u0438 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u044B","no-range":"\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F","bad-range":"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D\u0430 \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F"}},library={build:function d(a,b){var c=this;a.forEach(function(a){return c.addChan(a,b||(a.default?"default":"custom"))})},buildChan:function h(a,b){if(b=b||a.section,!b)return console.error("No section specified for buildChan()");var c=a.ball||"/chans/balls/".concat(b,"/").concat("drafts"==b?"no-ball":a.id,".png?uid=").concat(a._id).concat(a.ballv?"&v=".concat(a.ballv):""),d="".concat(a.id," ").concat(a.name," ").concat(a.url.replace(/^https?:\/\//,"")," ").concat((a.wiki||"").replace(/^https?:\/\//,"")).toLowerCase().trim().replace(/[<>""]/g,""),e="drafts"===b?"\n\t\t<button class=\"btn export-draft\">\n\t\t\t<svg class=\"icon\" title=\"\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A\"><use xlink:href=\"#i-download\"></use></svg>\n\t\t</button>":"",f=escHTML(_templateObject12,b,a.name?"":" no-name",a.id,d,c,a.name||"\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438")+e+"\n\t\t</li>",g=$(f);return a.section=b,g[0]._libdata=a,g},addChan:function f(a,b,c){if("undefined"==typeof c&&(c=!1),b=b||a.section,!b)return console.error("No section specified for addChan()");var d=this.buildChan(a,b);d.appendTo("#chans"),c&&this.highlight(d);var e=d[0]._libdata;return e},editChan:function d(a){var b=$(jq(_templateObject13,a.id)),c=b[0]._libdata;return _.assign(c,a),b.replaceWith(this.buildChan(c,c.section)),this.highlight($(jq(_templateObject13,a.id))),c},deleteChan:function b(a){$(jq(_templateObject13,a)).remove()},highlight:function c(a){var b=a[0]._libdata.section;$(jq(_templateObject14,b)).click(),a.addClass("fresh"),toggleLib(!0)}},libchan={load:function c(a){upForm.toggle(),this.current=a,this.current.default=+("default"==a.section),this.current.included=+a.included,this.setMode("edit",a.section),$("#chan-id").val(a.id),$("#chan-name").val(a.name).trigger("input"),$("#chan-url").val(a.url),$("#chan-wiki").val(a.wiki||""),$("#chan-userboards").val(a.userboards||""),$("#chan-userboards_catname").val(a.userboards_catname||"2.0"),$("#chan-userboards_system").val(a.userboards_system||"instant"),ball.setBall(a);var b=a.offset||[0,0];$("#position-tweak-left").val(b[0]),$("#position-tweak-top").val(b[1]),ball.offset(),$("#bgc-from")[0].jscolor.fromString(a.catbg[0]),$("#bgc-to")[0].jscolor.fromString(a.catbg[1]),gradient.update(),$("#chan-prefix").val(a.prefix||""),$("#chan-postfix").val(a.postfix||""),tree.build(a.boards),$("#custom-css").prop("checked",!!a.colors),a.colors?($("#color-theme").show(),$("#bgColor")[0].jscolor.fromString(a.colors[0]),$("#linkColor")[0].jscolor.fromString(a.colors[1]),a.advanced_less?($("#advance-less").prop("checked",1).trigger("change"),$("#less-enter").val(lessFormatter.prettify(a.advanced_less))):($("#less-enter").val(lessFormatter.prettify(styles.base)),$("#advance-less").prop("checked",0).trigger("change")),styles.update()):styles.reset(),a.radio?($("#radio-editor").show(),radio.build(a.radio),$("#radio").prop("checked",!0)):radio.reset(),$("#default").prop("checked","default"===a.section),$("#included").prop("checked",!!a.included),this.rinse()},_schema:{integrity:{required:["id","name","url","boards","ball","offset","catbg"],optional:["userboards","prefix","postfix","wiki","radio","colors","advanced_less","userboards_catname","userboards_system"],adminOnly:["default","included"]},specialComps:{pairs:["catbg","offset","colors"],objects:["boards","radio"],isNewBall:["ball"]},conversions:{toFile:["ball"]},defaults:{"":["userboards","prefix","postfix","wiki"],"FFFFFF|FFFFFF":["catbg"],"0|0":["offset"],"2C333D|37C999":["colors"],"2.0":["userboards_catname"],instant:["userboards_system"]},fns:{objects:_.eq.bind(_),pairs:function d(a,b){var c=[a,b].map(function(a){return a instanceof Array?a.join("|").toLowerCase():a});return c[0]===c[1]},isNewBall:function c(a,b){return a?b===a:"default"===b},toFile:function b(a){return 0===a.indexOf("data:")?a.toBlob():a}}},init:function c(){var a=this,b={};_.each(this._schema.integrity,function(a,c){a.forEach(function(a){b[a]={},b[a][c]=!0,"optional"===c&&(b[a].default=null)})}),_.each(this._schema.specialComps,function(c,d){c.forEach(function(c){b[c].eqFn=a._schema.fns[d]})}),_.each(this._schema.conversions,function(c,d){c.forEach(function(c){b[c].conv=a._schema.fns[d]})}),_.each(this._schema.defaults,function(a,c){a.forEach(function(a){b[a].default=c})}),this.schema=b},mode:"new",setMode:function c(a,b){this.mode=a,$("body").toggleClass("edit-draft","edit"===a&&"drafts"===b),$("#chan-id, #save-draft").prop("disabled","edit"===a&&"drafts"!==b),$("#clone-this, #delete-this").prop("disabled","new"===a)},rinse:function a(){$(".tipper").setTipperState("question"),$("input").removeClass("invalid")},collectData:function c(a){var b="draft"===a;return new Promise(function(a,c){var d={},e=[];if(["url","name","id","wiki","userboards","userboards_catname","prefix","postfix"].forEach(function(a){var c=$(jq(_templateObject15,a))[0].validate(0,b).then(function(b){d[a]=b});e.push(c)}),e.push(ball.getData(b).then(function(a){_.assign(d,a)})),e.push(new Promise(function(a,c){var e=tree.toggleView("UI",b);if(e)a(e);else if(!1===e)c();else{var f=tree.validateUI(b);f?a(f):c()}d.boards=!1!==tree.toggleView("UI")&&tree.validateUI()}).then(function(a){d.boards=a})),d.userboards_system=$("#chan-userboards_system").val(),$("#radio").prop("checked")&&e.push(radio.getData(b).then(function(a){d.radio=a})),$("#custom-css").prop("checked")&&e.push(styles.getData(b).then(function(a){_.assign(d,a)})),IS_ADMIN){var f={};["default","included"].forEach(function(a){f[a]=+$(jq(_templateObject,a)).prop("checked")}),_.assign(d,f)}Promise.all(e).then(function(){return a(d)},function(){return c("fix-errors")})})},proceedWithData:function e(a,b){var c=this,d=b&&this.current&&"drafts"===this.current.section?"new":this.mode;return new Promise(function(b,e){var f=new FormData,g={},h=[];c.collectData(a).then(function(i){"edit"===d&&libchan.current.id!==i.id&&h.push("id-changed"),_.each(c.schema,function(b,c){var e;if(!b.adminOnly||IS_ADMIN){if(i.hasOwnProperty(c)?e=i[c]:b.required?h.push("fill-required-fields"):e=null,"edit"===d&&"id"!==c){var j=libchan.current.hasOwnProperty(c)?libchan.current[c]:b.default;if(b.eqFn?b.eqFn(j,e):j===e)return}else if(null===e)return;g[c]=e,"upload"===a&&(b.conv&&(e=b.conv(e)),f.apnd(c,e))}}),h.length?e(_.uniq(h)):(DO_DEBUG&&console.log(g),b({obj:g,fd:f}))},function(a){e(a)})})},clone:function a(){this.setMode("new"),ball.toDataURL(),$("#chan-id").val(""),$("#chan-name")[0].value+=" (\u043A\u043B\u043E\u043D)",$("#chan-name").trigger("input")},clear:function a(){["url","name","id","wiki","userboards","prefix","postfix"].forEach(function(a){return $(jq(_templateObject15,a)).val("")}),$("#chan-userboards_catname").val("2.0"),ball.clear(),["from","to"].forEach(function(a){return $(jq(_templateObject3,a))[0].jscolor.fromString("ffffff")}),gradient.update(),[radio,styles].forEach(function(a){return a.reset()}),tree.build("[]"),tree.toggleView("UI"),this.rinse(),this.current=null,this.setMode("new"),upForm.toggle()}},drafts={model:[],load:function b(){var a=localStorage.mydrafts;if(a)try{var c=JSON.parse(a);if("object"!==_typeof(c)||!c.hasOwnProperty("chans"))throw new Error;this.model=c.chans}catch(a){console.error("Drafts in localStorage are corrupted and will be purged"),localStorage.removeItem("mydrafts")}library.build(this.model,"drafts")},remove:function b(a){this.model.splice(_.findIndex(this.model,{id:a}),1),library.deleteChan(a),libchan.setMode("new"),this.sync()},add:function c(a){var b=library.addChan(a,"drafts",1);this.model.push(a),libchan.current=b,libchan.setMode("edit","drafts")},edit:function c(a){var b=library.editChan(a);this.model[_.findIndex(this.model,{id:a.id})]=b},sync:function a(){localStorage.mydrafts=JSON.stringify({chans:this.model,version:new Date().getTime()})},submit:function c(){var a=this,b=$("#chan-id").val();if("edit"===libchan.mode&&libchan.current.id!==b)return $("#id-to-change").text(libchan.current.id),void upForm.toggle("prompt pr-idchanged");if("new"===libchan.mode&&_.find(this.model,{id:b})){$("#id-to-overwrite").text(b);var d=/(.+?)(\d+)$/.exec(b);return $("#proposed-id").text(d?"".concat(d[1]).concat(+d[2]+1):"".concat(b,"2")),void upForm.toggle("prompt pr-idexists")}upForm.toggle();libchan.proceedWithData("draft").then(function(b){var c=b.obj;"edit"===libchan.mode?a.edit(c):a.add(c),a.sync()},function(a){upForm.showErrors(a)})}};libchan.init();var lessFormatter={minify:function b(a){return a.replace(/\n/g," ").replace(/\s{2,}/g," ").trim()},prettify:function b(a){return css_beautify(this.minify(a).replace(/([;{}])/g,"$1\n").replace(/^\s+/gm,"").trim(),{indent_char:"\t",indent_size:1,newline_between_rules:!1})}},validations={urlencode:function b(a){return encodeURI(a)},checkuniq:function c(a,b){return new Promise(function(c,d){return"edit"===libchan.mode&&libchan.current[b]===a?void c():void $.get("api.php?checkuniq&prop=".concat(b,"&val=").concat(encodeURIComponent(a))).then(function(a){a.error?d("occupied"):c()}).fail(function(a){console.error("XHR error during post-validation",a),d("XHR error")})})}};NodeList.prototype.forEach=Array.prototype.forEach,NodeList.prototype.map=Array.prototype.map,FormData.prototype.apnd=function(a,b){"object"!==_typeof(b)||b instanceof Blob?this.append(a,b):this.append(a,JSON.stringify(b))},FormData.prototype.inspect=function(){var a=!0,b=!1,c=void 0;try{for(var d,e,f=this.entries()[Symbol.iterator]();!(a=(d=f.next()).done);a=!0)e=d.value,console.log(e[0]+" = "+e[1])}catch(a){b=!0,c=a}finally{try{a||null==f.return||f.return()}finally{if(b)throw c}}},Blob.prototype.readAsDataURL=function(a){var b=new FileReader;b.onload=function(b){return a(b.target.result)},b.readAsDataURL(this)},String.prototype.toBlob=function(){try{for(var a=this.split(","),b=a[0].match(/:(.*?);/)[1],c=atob(a[1]),d=c.length,e=new Uint8Array(d);d--;)e[d]=c.charCodeAt(d);return new Blob([u8arr],{type:mime})}catch(a){return console.error(a),!1}};function getDataUri(a,b){var c=new Image;c.onload=function(){var a=document.createElement("canvas");a.width=this.naturalWidth,a.height=this.naturalHeight,a.getContext("2d").drawImage(this,0,0),b(a.toDataURL("image/png"))},c.src=a}function mixedRange(a){for(var b,c=[],d=/(?:([0-9]+)(?:\-([0-9]+))?(?:, ?)?)/g;null!==(b=d.exec(a));)b.index===d.lastIndex&&d.lastIndex++,b[2]?c=c.concat(_.range(b[1],+b[2]+1)):c.push(+b[1]);return c}var upForm={$form:null,init:function b(){var a=this;this.$form=$("#upload-form").on("submit",this.submit.bind(this)),_.each(this.actorFieldMap,function(b,c){b.forEach(function(b){return a.fieldActorMap[b]=c})})},toggle:function b(a){if(!a)this.$form.removeClass("expanded");else{this.$form.removeClass("f-upload f-delete f-prompt pr-idchanged pr-idexists").addClass("f-".concat(a," expanded"));var c=libchan.current&&"drafts"===libchan.current.section&&"delete"===a;$("#upload-form input").prop("required",!c),!c&&$(".captcha").hasClass("not-loaded")&&refreshCaptcha()}},checkFields:function a(){return $("#pswd").val()&&$("#captcha").val()},submit:function d(a){var b=this;a.preventDefault();var c=this.$form.hasClass("f-delete")?"delete":"upload";if(libchan.current&&"drafts"===libchan.current.section&&"delete"==c)return drafts.remove(libchan.current.id),void this.toggle();if(!this.checkFields())return this.showErrors("fill-required-fields");if(this.$form.addClass("busy"),"upload"==c)libchan.proceedWithData(c,!0).then(function(a){b.candidate=a.obj,b.send(libchan.mode,a.fd)},function(a){b.showErrors(a),b.$form.removeClass("busy")});else{var e=new FormData;$("#chan-id")[0].validate(1).then(function(a){e.apnd("id",a),b.candidate={id:a},b.send("delete",e)},function(a){return console.error(a)})}},send:function e(a,b){libchan.current&&"drafts"===libchan.current.section&&(a="new"),b.apnd("action",a),b.apnd("captcha",$("#captcha").val()),b.apnd("password",$("#pswd").val()),DO_DEBUG&&b.inspect();var c=new XMLHttpRequest;c.open("POST","api.php"),c.send(b);var d=this;c.onload=function(a){if(200==this.status){var b=0;try{b=JSON.parse(this.response)}catch(a){console.error(a),console.warn(this.response),d.unbusy(),d.showErrors("invalid-response")}b&&d.handleResponse(b)}else d.unbusy(),d.showErrors("xhr-error"),console.error(a)}},showErrors:mkErrorShower("submit"),errorDescriptors:{"fill-required-fields":"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u044B\u0435 \u043F\u043E\u043B\u044F","xhr-error":"\u041E\u0448\u0438\u0431\u043A\u0430 XHR. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.","invalid-response":"\u041E\u0448\u0438\u0431\u043A\u0430 XHR (\u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u043E\u0442\u0432\u0435\u0442\u0430). \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.","id-changed":"ID \u0431\u044B\u043B \u043D\u0435\u043B\u0435\u0433\u0430\u043B\u044C\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D.","nothing-to-edit":"\u041D\u0435\u0447\u0435\u0433\u043E \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",missing:"\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u043F\u0430\u0440\u043E\u043B\u044C","wrong-captcha":"\u041A\u0430\u043F\u0447\u0430 \u0432\u0432\u0435\u0434\u0435\u043D\u0430 \u043D\u0435\u0432\u0435\u0440\u043D\u043E","wrong-password":"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C","fix-errors":"\u0418\u0441\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u043E\u0448\u0438\u0431\u043A\u0438!","db-error":"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u0438\u0441\u0438 \u0432 \u0411\u0414","not-admin":"\u041D\u0435\u043F\u043E\u0445\u043E\u0436\u0435, \u0447\u0442\u043E \u0432\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440","wrong-value":"\u041D\u0435\u0432\u0435\u0440\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435","chan-does-not-exist":"\u0417\u0430\u043F\u0438\u0441\u044C \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0411\u0414"},actorFieldMap:{ball:["ball","catbg","offset"],styles:["colors","advanced_less"],tree:["boards"],radio:["radio"],admin:["admin"]},fieldActorMap:{},unbusy:function a(){this.$form.removeClass("busy"),refreshCaptcha()},handleResponse:function e(a){var b=this;if(this.unbusy(),a.error){var f=a.error;f instanceof Array||(f=[f]),f=f.map(function(a){if(!a.field)a={field:b,msg:a};else{var c=$(jq(_templateObject15,a.field));a.field=c.length&&c[0].showErrors?c[0]:b.fieldActorMap.hasOwnProperty(a.field)?window[b.fieldActorMap[a.field]]:b}return a});var g=_.uniq(_.pluck(f,"field"));_.includes(g,this)||(f.push({field:this,msg:"fix-errors"}),g.push(this)),g.forEach(function(a){var c=_.pluck(_.filter(f,{field:a}),"msg").map(function(a){return b.errorDescriptors[a]||a});a.showErrors(_.uniq(c))})}else{if(this.showErrors([]),"new-success"===a.action){drafts.remove(upForm.candidate.id),delete this.candidate.ball;var c=this.candidate.section&&"default"===this.candidate.section?"default":"custom",d=library.addChan(this.candidate,c,!0);libchan.load(d),console.log(upForm.candidate.id,this.candidate,c)}if("edit-success"===a.action){a.moveto&&(this.candidate.section=a.moveto);var h=library.editChan(this.candidate);libchan.load(h)}"delete-success"===a.action&&(library.deleteChan(this.candidate.id),libchan.setMode("new","draft")),this.toggle()}}},DO_DEBUG=!1;function makeEscapeTagLiteralFn(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:function(a){return a};return function(b){for(var c="",d=0;d<b.length;d++)c+=b[d],d<(1>=arguments.length?0:arguments.length-1)&&(c+=a(""+(1>d+1||arguments.length<=d+1?void 0:arguments[d+1])));return c}}var jq=makeEscapeTagLiteralFn(function(a){return a.replace(/([!"#$%&'()*+,\-./:;<=>?@[\\\]^`{|}~ ])/g,"\\$1")}),escHTML=makeEscapeTagLiteralFn(_.escape);function LSfetchJSON(a){var b=null,c=localStorage[a];if("undefined"!=typeof c)try{b=JSON.parse(c)}catch(b){console.error(b),localStorage.removeItem(a)}return b}function downloadJSON(a,b){var c=document.getElementById("dl-victim");c.setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(a))),c.setAttribute("download","".concat(b,".json")),c.click()}
//# sourceMappingURL=editor.js.map