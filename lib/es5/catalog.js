'use strict';var _templateObject=_taggedTemplateLiteral(['#tab-',''],['#tab-','']),_templateObject2=_taggedTemplateLiteral(['#cat_',''],['#cat_','']),_templateObject3=_taggedTemplateLiteral(['#installed_',''],['#installed_','']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}))}var main=function(){$.ajaxSetup({dataType:'json'}),$('#drawer, #hijab').click(function(){return $('body').toggleClass('list-collapsed')});var fetchPromises=[new Promise(function(resolve,reject){$.getJSON('/chans/chans.json?v='+new Date().getTime()).done(function(data){catalog.add(data.chans),resolve({origin:'server',version:data.version})}).fail(function(err){return reject(err)})})];if(localStorage.mydrafts){var myDrafts=null;try{myDrafts=JSON.parse(localStorage.mydrafts),catalog.myDraftsRaw=_.cloneDeep(myDrafts.chans)}catch(e){localStorage.removeItem('mydrafts'),console.error(e)}myDrafts.chans&&fetchPromises.push(new Promise(function(resolve){var myDraftsValid=[];myDrafts.chans.forEach(function(draft){draft.name&&draft.url&&draft.id&&draft.id.match(/^[a-z\-_0-9]+$/)?(draft.originalID=draft.id,draft.id+='!draft',myDraftsValid.push(draft)):errorBoy.pushError('\u0427\u0435\u0440\u043D\u043E\u0432\u0438\u043A #'+draft.id+' \u043D\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433: \u043D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u0434\u0430\u043D\u043D\u044B\u0445 \u0438\u043B\u0438 \u043D\u0435\u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 ID.')}),catalog.add(myDraftsValid,'drafts'),resolve({origin:'drafts',version:myDrafts.version})}))}Promise.all(fetchPromises).then(list.init.bind(list),function(err){return console.error(err)}),$('.tab').click(function(ev){var $chev=$(this).parent().find('.icon');if('block'===$chev.css('display')&&1==$chev.css('opacity'))ev.stopPropagation(),$('#catalog header').addClass('tab-selecting');else{var tab=$(this).text().toLowerCase();switchTab(tab)}});var ctab=localStorage['cat-tab'];ctab&&switchTab(ctab),$('#toggle-search').click(function(){$('#catalog').addClass('searching'),$('#search').focus()}),$('#search').on('input',function(){var val=$(this).val().trim().toLowerCase();$('#catalog').toggleClass('search-filter',!!val.length),injector.inject('cat-search','.search-filter .cat-chan[data-search *= "'+val+'"] {display: inline-block}')}),$('#cancel-search').click(function(){$('#catalog').removeClass('searching search-filter'),$('#search').val('')}),$('body').click(function(){return $('#catalog header').removeClass('tab-selecting')}).on('click','.cc-install',function(){var $ch=$(this).parents('.cat-chan');list.toggle($ch[0]._libdata)}).on('click','.make-embed',function(){$(this).parents('.cat-chan').toggleClass('code-on')}).on('dragenter dragend dragover drop dragleave',function(ev){ev.preventDefault(),ev.stopPropagation()}).on('drop',function(ev){return handleFile(ev.originalEvent)}),$('#up-victim').on('change',function(ev){return handleFile(ev.originalEvent)}),$('#import-draft').click(function(){return $('#up-victim').click()})};function switchTab(tab){$('.tab').removeClass('tab-selected'),$(jq(_templateObject,tab)).addClass('tab-selected'),$('#catalog').removeClass('tab-default tab-custom tab-drafts').addClass('tab-'+tab),localStorage['cat-tab']=tab}var errorBoy={pushError:function pushError(msg){$('#error-wrapper').append('<div class="errmsgbox" onclick="this.remove()"><svg id="close-errmsg" class="icon"><use xlink:href="#i-x"></use></svg><p class="error-message">'+_.escape(msg)+'</p></div>')}},list={init:function init(vers){var versMap={};vers.forEach(function(v){return versMap[v.origin]=v.origin}),this.versions=versMap,localStorage.catalogVersions=JSON.stringify(versMap),this.sortable=Sortable.create(document.querySelector('#boardlist'),{handle:'.dragger',animation:150,onSort:this.sync.bind(this)});var myList=localStorage.myChans_new,myListUpdated=[];if(myList){try{myList=JSON.parse(myList)}catch(e){console.error(e),localStorage.removeItem('myChans_new'),myList=null}myList&&myList.length&&myList.forEach(function(ich){var actual=catalog.chanByID(ich.id);actual&&myListUpdated.push(actual)})}myList||$('.included-chan').each(function(){myListUpdated.push(this._libdata)}),this.add(myListUpdated)},add:function add(chans){var _this=this;arrayify(chans).forEach(function(chan){['catbg','offset'].forEach(function(prop){return delete chan[prop]});var $ch=$(_this.buildChan(chan));$ch[0]._libdata=chan,$('#boardlist').append($ch),$(jq(_templateObject2,chan.id)).addClass('installed')}),this.sync()},buildChan:function buildChan(chan){var name=_.escape(chan.name),ballSrc=chan.ball||'/chans/balls/'+chan.section+'/'+('drafts'==chan.section?'no-ball':chan.id)+'.png?uid='+chan._id+(chan.ballv?'&v='+chan.ballv:'');return'<li class="list-chan" id="installed_'+chan.id+'" data-id="'+chan.id+'"><img src="'+ballSrc+'" class="list-chanball"><div class="dragger"><svg class="icon"><use xlink:href="#i-drag"></use></div><div class="list-chan-title">'+(name||'\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438')+'</div><div class="delete-chan" onclick="javascript:list.remove(\''+chan.id+'\')"><svg class="icon"><use xlink:href="#i-x"></use></div></li>'},toggle:function toggle(chan){_.includes(this.sortable.toArray(),chan.id)?this.remove(chan.id):this.add(chan)},remove:function remove(id){$(jq(_templateObject3,id)).remove(),$(jq(_templateObject2,id)).removeClass('installed'),this.sync()},sync:function sync(){var res=[];document.querySelectorAll('.list-chan').forEach(function(ch){res.push(ch._libdata)}),localStorage.removeItem('compiledCSS'),localStorage.myChans_new=JSON.stringify(res)}},catalog={add:function add(chans,section){var _this2=this;arrayify(chans).forEach(function(chan){chan.section||(chan.section=section||(chan.default?'default':'custom')),chan.url=_.escape(chan.url);var $ch=$(_this2.buildChan(chan));$ch[0]._libdata=chan,$('#catalog-contents').append($ch)}),$('#import-draft').insertAfter('.cat-chan:last')},buildChan:function buildChan(chan){var name=_.escape(chan.name),wiki=chan.wiki&&chan.wiki.match(/https?:\/\//)?chan.wiki:conf.wiki+(chan.wiki||name),search=(chan.originalID||chan.id)+' '+name+' '+chan.url.replace(/^https?:\/\//,'')+' '+(chan.wiki||'').replace(/^https?:\/\//,''),ballSrc=chan.ball||'/chans/balls/'+chan.section+'/'+('drafts'==chan.section?'no-ball':chan.id)+'.png?uid='+chan._id+(chan.ballv?'&v='+chan.ballv:'');return'<div class="cat-chan sect-'+chan.section+' '+(chan.included?'included-chan':'')+'" data-search="'+search.toLowerCase()+'" id="cat_'+chan.id+'"><div class="cc-ball-wrap" style="'+makeGradient(chan.catbg)+'"><img src="'+ballSrc+'" class="cc-ball" '+(chan.offset?makeOffset(chan.offset):'')+'></img><div class="channame-overlay"><a href="'+chan.url+'">'+name+'</a></div></div><div class="cc-toolbar"><button class="cc-install"><span class="cci-i">\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C</span><span class="cci-u">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</span></button></div><div class="chan-options make-embed" title="\u041A\u043E\u0434 \u0434\u043B\u044F \u043A\u043D\u043E\u043F\u043A\u0438"><svg class="icon"><use class="co-code" xlink:href="#i-code"></use><use class="co-close" xlink:href="#i-x"></use></svg></div><a class="chan-options info-link" target="_blank" href="'+wiki+'" title="\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F"><svg class="icon"><use xlink:href="#i-info"></use></svg></a><textarea onclick="this.select()">'+_.escape('<script src="'+(document.location.origin||document.location.protocol+'//'+document.location.host)+'/embed/add.js" chan="'+chan.id+'"></script>')+'</textarea></div>'},chanByID:function chanByID(id){var ch=document.querySelector(jq(_templateObject2,id));return ch&&ch._libdata?ch._libdata:null},myDraftsRaw:[],syncRawDrafts:function syncRawDrafts(){localStorage.mydrafts=JSON.stringify({version:new Date().getTime(),chans:this.myDraftsRaw})}};function arrayify(arr){return arr instanceof Array?arr:[arr]}var injector={inject:function inject(alias,css){var id='injector:'+alias,existing=document.getElementById(id);if(existing)return void(existing.innerHTML=css);var head=document.head||document.getElementsByTagName('head')[0],style=document.createElement('style');style.type='text/css',style.id=id,style.styleSheet?style.styleSheet.cssText=css:style.appendChild(document.createTextNode(css)),head.appendChild(style)},remove:function remove(alias){var id='injector:'+alias,style=document.getElementById(id);if(style){var head=document.head||document.getElementsByTagName('head')[0];head&&head.removeChild(document.getElementById(id))}}};function makeGradient(colors){var unprefixed='linear-gradient(to bottom, #'+colors[0]+' 0%, #'+colors[1]+' 100%)',res=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(unprefixed);if(null===res)return'background:'+unprefixed;res=_.rest(_.without(res,void 0));var gradientDirection,ret=res[0]+'; ',gradientType=res[1];gradientDirection=isNaN(res[2])?'bottom'==res[2]?'top, ':'right'==res[2]?'left, ':'center, ellipse cover, ':90-parseFloat(res[2])+'deg, ';var gradientStops=res[3];return _.each(['-o-','-webkit-','-moz-'],function(prefix){ret+='background:'+prefix+gradientType+'('+gradientDirection+gradientStops+'); '}),'background:'+ret}function makeOffset(offset){var left=offset[0],top=offset[1],ret='';return 0==left&&0==top?ret:(['','-webkit-','-ms-','-moz-','-o-'].forEach(function(prefix){ret+=prefix+'transform: translate('+left+'px, '+top+'px); '}),'style="'+ret+'"')}NodeList.prototype.forEach=Array.prototype.forEach;function makeEscapeTagLiteralFn(fn){return function(strings){for(var result='',i=0;i<strings.length;i++)result+=strings[i],i<(1>=arguments.length?0:arguments.length-1)&&(result+=fn(arguments.length<=i+1?void 0:arguments[i+1]));return result}}var jq=makeEscapeTagLiteralFn(function(v){return v.replace(/([!"#$%&'()*+,\-./:;<=>?@[\\\]^`{|}~ ])/g,'\\$1')}),conf={wiki:'http://wiki.1chan.ca/'};function reloadFrame(){parent.frames.list.document.location.reload(),parent.openMenu()}window.addEventListener('message',function(){parent.frames.live.document.location.reload()},!1);function handleFile(ev){var files='drop'==ev.type?ev.dataTransfer.files:ev.target.files,f=files[0];if(f){var reader=new FileReader;reader.onload=function(){return function(e){var imported=null;try{imported=JSON.parse(e.target.result)}catch(err){errorBoy.pushError('\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u043E\u0431\u0440\u0430\u0442\u044C JSON')}if(imported){if(!(imported.name&&imported.url&&imported.id&&imported.id.match(/^[a-z\-_0-9]+$/)))return void errorBoy.pushError('\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A. \u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u0434\u0430\u043D\u043D\u044B\u0445.');if(_.find(catalog.myDraftsRaw,{id:imported.id}))return void errorBoy.pushError('\u0427\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442');catalog.myDraftsRaw.push(_.cloneDeep(imported)),catalog.syncRawDrafts(),imported.id+='!draft',catalog.add(imported,'drafts')}}.bind(this)}.bind(this)(f),reader.readAsText(f)}}console.info('\u042F \u043D\u0435 \u043D\u0430 \u0430\u043D\u0433\u0443\u043B\u044F\u0440\u0435. \u041D\u0435 \u043D\u0430 \u0430\u043D\u0433\u0443\u043B\u044F\u0440\u0435.');
//# sourceMappingURL=catalog.js.map